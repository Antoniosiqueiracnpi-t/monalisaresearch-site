<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Upload de Relat√≥rios</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* Login Container */
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-container h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .login-form .form-group {
            margin-bottom: 0;
            text-align: left;
        }
        
        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="password"], input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f8f8;
        }
        
        input[type="password"]:focus, select:focus, input[type="text"]:focus, 
        input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-login:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-login:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-login {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .security-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 10px;
            font-size: 12px;
            color: #666;
        }
        
        /* Upload Container */
        .upload-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            display: none;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px dashed rgba(255, 255, 255, 0.5);
        }
        
        .file-upload-label:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border-color: white;
        }
        
        .file-upload-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .file-upload-text small {
            display: block;
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            font-weight: normal;
        }
        
        .file-selected {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-color: transparent;
        }
        
        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }
        
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: slideIn 0.5s ease;
        }
        
        .success-message {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .reports-list {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        .reports-list h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .report-item {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .report-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .report-info {
            flex-grow: 1;
        }
        
        .report-type {
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        .report-date {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-delete {
            background: #f5576c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-delete:hover {
            background: #e63946;
            transform: scale(1.05);
        }
        
        .upload-progress {
            display: none;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        /* Access Control Styles */
        .access-control {
            margin-top: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 10px;
        }
        
        .access-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .access-option input[type="radio"] {
            width: auto;
        }
        
        .access-option label {
            margin-bottom: 0;
            font-weight: normal;
            text-transform: none;
        }
        
        .access-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .badge-public {
            background: #2ecc71;
            color: white;
        }
        
        .badge-private {
            background: #e74c3c;
            color: white;
        }
        
        .code-section {
            margin-top: 40px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
        }
        
        .code-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .current-code {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-display {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 2px;
        }
        
        .btn-generate {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-generate:hover {
            background: #5a6dc7;
        }

        /* JSON Positions Upload Styles */
        .json-upload-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(26, 188, 156, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(26, 188, 156, 0.2);
        }

        .json-upload-section h2 {
            color: #1ABC9C;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .json-strategy-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .json-strategy-option {
            background: rgba(26, 188, 156, 0.05);
            border: 2px solid rgba(26, 188, 156, 0.2);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .json-strategy-option:hover {
            border-color: #1ABC9C;
            background: rgba(26, 188, 156, 0.1);
        }

        .json-strategy-option.selected {
            border-color: #1ABC9C;
            background: rgba(26, 188, 156, 0.15);
        }

        .json-strategy-option input[type="radio"] {
            display: none;
        }

        .json-strategy-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .json-strategy-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .json-strategy-desc {
            font-size: 0.85rem;
            color: #666;
        }

        .json-file-upload {
            position: relative;
            margin-bottom: 20px;
        }

        .json-file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .json-file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px dashed rgba(255, 255, 255, 0.5);
        }

        .json-file-upload-label:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(26, 188, 156, 0.3);
            border-color: white;
        }

        .json-file-upload-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .json-file-upload-text small {
            display: block;
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            font-weight: normal;
        }

        .json-file-selected {
            background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%);
            border-color: transparent;
        }

        .btn-upload-json {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .btn-upload-json:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(26, 188, 156, 0.4);
        }

        .btn-upload-json:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .json-files-list {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(26, 188, 156, 0.2);
        }

        .json-files-list h3 {
            color: #1ABC9C;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .json-file-item {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .json-file-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .json-file-info {
            flex-grow: 1;
        }

        .json-file-strategy {
            font-weight: 600;
            color: #1ABC9C;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .json-file-date {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .json-file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }



    </style>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
	<script src="email-service.js"></script>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <h1>üîí √Årea Administrativa</h1>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="password">Senha de Acesso</label>
                <input type="password" id="password" placeholder="Digite a senha" required>
            </div>
            <button type="submit" class="btn-login">
                Entrar
            </button>
            <div class="error-login" id="loginError">
                Senha incorreta. Tente novamente.
            </div>
        </form>
        <div class="security-info">
            üîê Acesso restrito. Todas as tentativas s√£o registradas.
        </div>
    </div>

    <!-- Upload Container -->
    <div class="upload-container" id="uploadContainer">
        <button class="logout-btn" onclick="logout()">Sair</button>
        
        <h1>üìä Upload de Relat√≥rios</h1>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="reportType">Tipo de Relat√≥rio *</label>
                <select id="reportType" required>
                    <option value="">Selecione o tipo...</option>
                    <optgroup label="Carteiras e Estrat√©gias">
                        <option value="brasil">Monalisa Brasil - A√ß√µes B3</option>
                        <option value="global">Monalisa Global - S&P 500</option>
                        <option value="quant">Monalisa Quant - Trading</option>
                        <option value="opcoes">Monalisa Op√ß√µes - Derivativos</option>
                        <option value="longshort">Monalisa Long and Short</option>
			<option value="vectordi">Monalisa Vector DI - Gest√£o Ativa RF</option>
                    </optgroup>
                    <optgroup label="An√°lise de Mercado">
                        <option value="graficos">Gr√°ficos em A√ß√£o - An√°lise T√©cnica</option>
                        <option value="rendafixa">De Olho na Renda Fixa</option>
			<option value="insights">Monalisa Insights - An√°lise de Mercado</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reportTitle">T√≠tulo do Relat√≥rio *</label>
                <input type="text" id="reportTitle" placeholder="Ex: Relat√≥rio Mensal - Agosto 2025" required>
            </div>
            
            <div class="form-group">
                <label for="reportDate">Data do Relat√≥rio *</label>
                <input type="date" id="reportDate" required>
            </div>
            
            <div class="form-group">
                <label for="reportSummary">Resumo *</label>
                <textarea id="reportSummary" placeholder="Descreva brevemente o conte√∫do do relat√≥rio..." required></textarea>
            </div>
            
            <!-- Controle de Acesso -->
            <div class="access-control">
                <label style="margin-bottom: 15px; display: block;">N√≠vel de Acesso *</label>
                <div class="access-option">
                    <input type="radio" id="accessPublic" name="accessLevel" value="public" checked>
                    <label for="accessPublic">
                        üåç P√∫blico - Todos os usu√°rios podem visualizar
                    </label>
                </div>
                <div class="access-option">
                    <input type="radio" id="accessPrivate" name="accessLevel" value="private">
                    <label for="accessPrivate">
                        üîí Privado - Apenas assinantes com c√≥digo de acesso
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Arquivo PDF * (M√°ximo: 30MB)</label>
                <div class="file-upload">
                    <input type="file" id="pdfFile" accept=".pdf" required>
                    <label for="pdfFile" class="file-upload-label" id="fileLabel">
                        <div class="file-upload-text">
                            üìÑ Clique ou arraste o PDF aqui
                            <small>Aceita apenas arquivos PDF at√© 30MB</small>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
            
            <button type="submit" class="btn-submit" id="submitBtn">
                Publicar Relat√≥rio
            </button>
        </form>
        
        <div class="success-message" id="successMessage">
            ‚úÖ Relat√≥rio publicado com sucesso!
        </div>
        
        <div class="error-message" id="errorMessage">
            ‚ùå Erro ao publicar relat√≥rio. Tente novamente.
        </div>
        
        <!-- Se√ß√£o do C√≥digo de Acesso -->
        <div class="code-section">
            <h3>üîë C√≥digo de Acesso para Assinantes</h3>
            <div class="current-code">
                <div>
                    <small style="color: #666;">C√≥digo Atual:</small>
                    <div class="code-display" id="currentCode">------</div>
                </div>
                <button class="btn-generate" onclick="generateNewCode()">
                    Gerar Novo C√≥digo
                </button>
            </div>
            <small style="color: #666;">
                Compartilhe este c√≥digo apenas com assinantes ativos. 
                O c√≥digo √© v√°lido at√© ser alterado.
            </small>
        </div>
        
        <div class="reports-list">
            <h2>üìö Relat√≥rios Publicados</h2>
            <div id="reportsList"></div>
        </div>

        <!-- Se√á√£o Upload JSON Posi√á√µes -->
        <div class="json-upload-section">
            <h2>üìä Upload de Posi√ß√µes JSON</h2>
            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 25px;">
                Upload dos dados de posi√ß√µes das estrat√©gias quantitativas para exibi√ß√£o na p√°gina inicial.
            </p>
            
            <form id="jsonUploadForm">
                <div class="form-group">
                    <label style="margin-bottom: 15px; display: block;">Selecione a Estrat√©gia *</label>
                    <div class="json-strategy-selector">
                        <div class="json-strategy-option">
                            <input type="radio" id="jsonQuant" name="jsonStrategy" value="quant" required>
                            <label for="jsonQuant">
                                <span class="json-strategy-icon">üìä</span>
                                <div class="json-strategy-name">Monalisa Quant</div>
                                <div class="json-strategy-desc">Posi√ß√µes swing trading</div>
                            </label>
                        </div>
                        <div class="json-strategy-option">
                            <input type="radio" id="jsonOpcoes" name="jsonStrategy" value="opcoes" required>
                            <label for="jsonOpcoes">
                                <span class="json-strategy-icon">üéØ</span>
                                <div class="json-strategy-name">Monalisa Op√ß√µes</div>
                                <div class="json-strategy-desc">Multi-estrat√©gias op√ß√µes</div>
                            </label>
                        </div>
                        <div class="json-strategy-option">
                            <input type="radio" id="jsonLongshort" name="jsonStrategy" value="longshort" required>
                            <label for="jsonLongshort">
                                <span class="json-strategy-icon">üìà</span>
                                <div class="json-strategy-name">Long & Short</div>
                                <div class="json-strategy-desc">Pairs trading</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Arquivo JSON * (M√°ximo: 5MB)</label>
                    <div class="json-file-upload">
                        <input type="file" id="jsonFile" accept=".json" required>
                        <label for="jsonFile" class="json-file-upload-label" id="jsonFileLabel">
                            <div class="json-file-upload-text">
                                üìÑ Clique ou arraste o JSON aqui
                                <small>Aceita apenas arquivos JSON at√© 5MB</small>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn-upload-json" id="jsonSubmitBtn">
                    Publicar Posi√ß√µes
                </button>
            </form>
            
            <div class="success-message" id="jsonSuccessMessage">
                ‚úÖ Posi√ß√µes publicadas com sucesso!
            </div>
            
            <div class="error-message" id="jsonErrorMessage">
                ‚ùå Erro ao publicar posi√ß√µes. Tente novamente.
            </div>
            
            <div class="json-files-list">
                <h3>üìã Arquivos JSON Carregados</h3>
                <div id="jsonFilesList"></div>
            </div>
        </div>

    </div> <!-- Fechamento do upload-container -->

	<script>
	// Google Sheets Service
	class GoogleSheetsService {
	    constructor() {
	        this.SPREADSHEET_ID = '1--E380ln9HjsiDX5fbw0NbZfXdWFn4CcTgx55Fgzw-w';
	        this.SHEET_NAME = 'Assinantes';
	        this.API_KEY = null;
	    }
	
	    initialize(apiKey) {
	        this.API_KEY = apiKey;
	    }
	
		async getActiveSubscribers() {
		    try {
		        if (!this.API_KEY) {
		            console.error("‚ùå Google Sheets API KEY n√£o inicializada!");
		            return [];
		        }
		
		        const range = `${this.SHEET_NAME}!A:H`;
		        const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${this.API_KEY}`;
		        
		        const response = await fetch(url);
		        if (!response.ok) {
		            console.error('Erro HTTP:', response.status);
		            throw new Error('Erro ao buscar assinantes');
		        }
		        
		        const data = await response.json();
		        const rows = data.values || [];
		        
		        console.log('Total de linhas na planilha:', rows.length);
		        
		        const activeSubscribers = [];
		        const hoje = new Date();
		        hoje.setHours(0, 0, 0, 0); // Normalizar para in√≠cio do dia
		
		        // Come√ßar da linha 2 (√≠ndice 1) para pular o cabe√ßalho
		        for (let i = 1; i < rows.length; i++) {
		            const row = rows[i];
		            
		            // IMPORTANTE: Algumas linhas podem ter menos colunas
		            // Verificar se pelo menos tem nome, CPF e email (3 primeiras colunas)
		            if (!row || row.length < 3) {
		                console.log(`Linha ${i+1}: Dados insuficientes, pulando...`);
		                continue;
		            }
		
		            // Extrair dados com valores padr√£o
		            const nome = (row[0] || '').trim();
		            const cpf = (row[1] || '').trim();
		            let email = (row[2] || '').trim();
		            const telefone = (row[3] || '').trim();
		            const tipo = (row[4] || 'INVESTIDOR').trim(); // Valor padr√£o se vazio
		            const status = (row[5] || '').trim();
		            const dataInicio = row[6] || '';
		            const dataFim = row[7] || '';
		
		            // Valida√ß√µes b√°sicas
		            if (!nome || !email) {
		                console.log(`Linha ${i+1}: Nome ou email vazio, pulando...`);
		                continue;
		            }
		
		            // Normalizar e validar e-mail
		            email = email.toLowerCase().replace(/['"]+/g, '').trim();
		            if (!email.includes('@')) {
		                console.log(`Linha ${i+1}: Email inv√°lido (${email}), pulando...`);
		                continue;
		            }
		
		            // Converter datas (dd/mm/yyyy ‚Üí Date)
		            const parseDate = (dateStr) => {
		                if (!dateStr) return null;
		                
		                // Tentar formato dd/mm/yyyy
		                const parts = dateStr.split('/');
		                if (parts.length === 3) {
		                    const [dia, mes, ano] = parts.map(p => parseInt(p));
		                    if (!isNaN(dia) && !isNaN(mes) && !isNaN(ano)) {
		                        return new Date(ano, mes - 1, dia); // mes - 1 porque JS usa 0-11
		                    }
		                }
		                
		                // Tentar outros formatos
		                const date = new Date(dateStr);
		                return isNaN(date.getTime()) ? null : date;
		            };
		
		            const inicioDate = parseDate(dataInicio);
		            const fimDate = parseDate(dataFim);
		
		            console.log(`Linha ${i+1}: ${nome} | ${email} | Status: "${status}" | Tipo: ${tipo}`);
		
		            // VERIFICA√á√ÉO MELHORADA DE STATUS ATIVO
		            const statusNormalizado = status.toLowerCase().trim();
		            const isStatusAtivo = statusNormalizado === 'ativo' || 
		                                  statusNormalizado === 'ativa' ||
		                                  statusNormalizado === 'active';
		            
		            // Verificar per√≠odo de validade
		            let dentroDoPer√≠odo = true;
		            
		            if (inicioDate && hoje < inicioDate) {
		                dentroDoPer√≠odo = false;
		                console.log(`  ‚Üí Ainda n√£o iniciou (in√≠cio: ${dataInicio})`);
		            }
		            
		            if (fimDate && hoje > fimDate) {
		                dentroDoPer√≠odo = false;
		                console.log(`  ‚Üí J√° expirou (fim: ${dataFim})`);
		            }
		
		            // Adicionar assinante se estiver ativo E dentro do per√≠odo
		            if (isStatusAtivo && dentroDoPer√≠odo) {
		                activeSubscribers.push({
		                    nome: nome,
		                    cpf: cpf,
		                    email: email,
		                    telefone: telefone,
		                    tipo: tipo || 'INVESTIDOR'
		                });
		                console.log(`  ‚úÖ Assinante ativo adicionado: ${nome} (${email})`);
		            } else {
		                if (!isStatusAtivo) {
		                    console.log(`  ‚ùå Status inativo: "${status}"`);
		                }
		                if (!dentroDoPer√≠odo) {
		                    console.log(`  ‚ùå Fora do per√≠odo de validade`);
		                }
		            }
		        }
		
		        console.log(`\n=========================`);
		        console.log(`Total de assinantes ativos encontrados: ${activeSubscribers.length}`);
		        console.log(`=========================\n`);
		        
		        return activeSubscribers;
		
		    } catch (error) {
		        console.error('Erro ao buscar assinantes ativos:', error);
		        console.error('Stack:', error.stack);
		        return [];
		    }
		}
	}
	
	// Inicializar servi√ßo
	const sheetsService = new GoogleSheetsService();
	</script>
    
    <script>
        // Sistema de Autentica√ß√£o
        const AUTH_CONFIG = {
            passwordHash: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', // admin
            sessionTimeout: 30 * 60 * 1000,
            maxAttempts: 5,
            lockoutTime: 15 * 60 * 1000
        };
        
        // Verificar autentica√ß√£o
        function checkAuth() {
            const session = sessionStorage.getItem('adminSession');
            if (!session) return false;
            
            try {
                const data = JSON.parse(session);
                if (Date.now() - data.timestamp > AUTH_CONFIG.sessionTimeout) {
                    sessionStorage.removeItem('adminSession');
                    return false;
                }
                return true;
            } catch {
                return false;
            }
        }
        
        // Hash SHA-256
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            const attempts = parseInt(localStorage.getItem('loginAttempts') || '0');
            const lastAttempt = parseInt(localStorage.getItem('lastLoginAttempt') || '0');
            
            if (attempts >= AUTH_CONFIG.maxAttempts) {
                if (Date.now() - lastAttempt < AUTH_CONFIG.lockoutTime) {
                    const minutesLeft = Math.ceil((AUTH_CONFIG.lockoutTime - (Date.now() - lastAttempt)) / 60000);
                    errorDiv.textContent = `Muitas tentativas. Tente novamente em ${minutesLeft} minutos.`;
                    errorDiv.style.display = 'block';
                    return;
                } else {
                    localStorage.removeItem('loginAttempts');
                    localStorage.removeItem('lastLoginAttempt');
                }
            }
            
            const passwordHash = await sha256(password);
            
            if (passwordHash === AUTH_CONFIG.passwordHash) {
                sessionStorage.setItem('adminSession', JSON.stringify({
                    timestamp: Date.now(),
                    authenticated: true
                }));
                
                localStorage.removeItem('loginAttempts');
                localStorage.removeItem('lastLoginAttempt');
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('uploadContainer').style.display = 'block';
                
                await loadReportsList();
                loadAccessCode();
            } else {
                const newAttempts = attempts + 1;
                localStorage.setItem('loginAttempts', newAttempts.toString());
                localStorage.setItem('lastLoginAttempt', Date.now().toString());
                
                errorDiv.textContent = `Senha incorreta. Tentativa ${newAttempts} de ${AUTH_CONFIG.maxAttempts}`;
                errorDiv.style.display = 'block';
                
                document.getElementById('password').value = '';
            }
        });
        
        // Logout
        function logout() {
            sessionStorage.removeItem('adminSession');
            window.location.reload();
        }
        
        // Sistema de C√≥digo de Acesso
        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function loadAccessCode() {
            let code = localStorage.getItem('subscriberAccessCode');
            if (!code) {
                code = generateAccessCode();
                localStorage.setItem('subscriberAccessCode', code);
            }
            document.getElementById('currentCode').textContent = code;
        }
        
        function generateNewCode() {
            if (confirm('ATEN√á√ÉO: Gerar novo c√≥digo invalidar√° IMEDIATAMENTE o c√≥digo atual.\n\nTodos os assinantes precisar√£o usar o novo c√≥digo.\n\nContinuar?')) {
                const newCode = generateAccessCode();
                localStorage.setItem('subscriberAccessCode', newCode);
                localStorage.setItem('codeGeneratedAt', Date.now().toString());
                
                document.getElementById('currentCode').textContent = newCode;
                
                alert('‚úÖ Novo c√≥digo gerado com sucesso!\n\n' + 
                      'C√≥digo: ' + newCode + '\n\n' +
                      '‚ö†Ô∏è IMPORTANTE:\n' +
                      '‚Ä¢ O c√≥digo anterior foi invalidado imediatamente\n' +
                      '‚Ä¢ Todos os assinantes precisam usar o novo c√≥digo\n' +
                      '‚Ä¢ Compartilhe o novo c√≥digo com seus assinantes ativos');
            }
        }
        
        // Upload de PDF para Supabase Storage
        async function uploadPDF(file, reportType) {
            const fileName = `${reportType}_${Date.now()}.pdf`;
            
            // Fazer upload do arquivo
            const { data, error } = await supabase.storage
                .from('reports')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (error) {
                console.error('Erro no upload:', error);
                throw error;
            }
            
            // Obter URL p√∫blico do arquivo
            const { data: urlData } = supabase.storage
                .from('reports')
                .getPublicUrl(fileName);
            
            return urlData.publicUrl;
        }
        
        // Salvar relat√≥rio no Supabase
        async function saveReport(reportData, file) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            
            try {
                // Upload do PDF primeiro
                progressDiv.style.display = 'block';
                progressFill.style.width = '30%';
                progressFill.textContent = 'Fazendo upload...';
                
                const fileUrl = await uploadPDF(file, reportData.type);
                
                progressFill.style.width = '60%';
                progressFill.textContent = 'Salvando dados...';
                
                // Dados do relat√≥rio
                const reportToSave = {
                    type: reportData.type,
                    title: reportData.title,
                    summary: reportData.summary,
                    report_date: reportData.date,
                    access_level: reportData.accessLevel,
                    file_url: fileUrl,
                    file_name: file.name,
                    file_size: file.size,
                    updated_at: new Date().toISOString()
                };
                
		// Primeiro deletar o existente
		await supabase
    			.from('reports')
    			.delete()
    			.eq('type', reportData.type);

		// Depois inserir o novo
		const { data, error } = await supabase
    			.from('reports')
    			.insert(reportToSave);
                
                if (error) throw error;
                
                progressFill.style.width = '100%';
                progressFill.textContent = 'Conclu√≠do!';
                
                return true;
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                throw error;
            }
        }
        
        // Listar relat√≥rios do Supabase
        async function loadReportsList() {
            try {
                const { data: reports, error } = await supabase
                    .from('reports')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('reportsList');
                
                const typeNames = {
                    'brasil': 'Monalisa Brasil',
                    'global': 'Monalisa Global',
                    'quant': 'Monalisa Quant',
                    'opcoes': 'Monalisa Op√ß√µes',
                    'longshort': 'Monalisa Long and Short',
                    'graficos': 'Gr√°ficos em A√ß√£o',
                    'rendafixa': 'De Olho na Renda Fixa',
		    'vectordi': 'Monalisa Vector DI',
		    'insights': 'Monalisa Insights'
                };
                
                if (!reports || reports.length === 0) {
                    container.innerHTML = '<p style="color: #888;">Nenhum relat√≥rio publicado</p>';
                    return;
                }
                
                container.innerHTML = reports.map(report => `
                    <div class="report-item">
                        <div class="report-info">
                            <div class="report-type">
                                ${typeNames[report.type] || report.type}
                                ${report.file_size ? `(${(report.file_size / 1024 / 1024).toFixed(1)} MB)` : ''}
                                <span class="access-badge badge-${report.access_level || 'public'}">
                                    ${report.access_level === 'private' ? 'üîí Privado' : 'üåç P√∫blico'}
                                </span>
                            </div>
                            <div class="report-date">
                                üìÖ ${new Date(report.updated_at).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                        <div class="report-actions">
                            <button class="btn-generate" onclick="toggleAccess('${report.id}', '${report.access_level}')">
                                ${report.access_level === 'private' ? 'Tornar P√∫blico' : 'Tornar Privado'}
                            </button>
                            <button class="btn-delete" onclick="removeReport('${report.id}', '${report.file_url}')">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista:', error);
            }
        }


        // Manipular sele√ß√£o de estrat√©gia JSON
        document.addEventListener('DOMContentLoaded', function() {
            const strategyOptions = document.querySelectorAll('.json-strategy-option');
            const radioInputs = document.querySelectorAll('input[name="jsonStrategy"]');
            
            strategyOptions.forEach((option, index) => {
                option.addEventListener('click', function() {
                    strategyOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    radioInputs[index].checked = true;
                });
            });
            
            radioInputs.forEach((radio, index) => {
                radio.addEventListener('change', function() {
                    strategyOptions.forEach(opt => opt.classList.remove('selected'));
                    if (this.checked) {
                        strategyOptions[index].classList.add('selected');
                    }
                });
            });
        });

        // Manipular arquivo JSON
        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('jsonFileLabel');
            const text = label.querySelector('.json-file-upload-text');
            
            if (file) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                const MAX_SIZE = 5 * 1024 * 1024;
                
                if (file.size > MAX_SIZE) {
                    alert(`Arquivo muito grande! M√°ximo: 5MB\nSeu arquivo: ${sizeMB}MB`);
                    this.value = '';
                    label.classList.remove('json-file-selected');
                    text.innerHTML = 'üìÑ Clique ou arraste o JSON aqui<small>Aceita apenas arquivos JSON at√© 5MB</small>';
                    return;
                }
                
                // Validar se √© JSON v√°lido
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        JSON.parse(event.target.result);
                        label.classList.add('json-file-selected');
                        text.innerHTML = `‚úÖ ${file.name}<small>${sizeMB} MB - JSON v√°lido</small>`;
                    } catch (error) {
                        alert('Arquivo JSON inv√°lido!');
                        document.getElementById('jsonFile').value = '';
                        label.classList.remove('json-file-selected');
                        text.innerHTML = 'üìÑ Clique ou arraste o JSON aqui<small>Aceita apenas arquivos JSON at√© 5MB</small>';
                    }
                };
                reader.readAsText(file);
            } else {
                label.classList.remove('json-file-selected');
                text.innerHTML = 'üìÑ Clique ou arraste o JSON aqui<small>Aceita apenas arquivos JSON at√© 5MB</small>';
            }
        });

        // Upload de JSON para Supabase Storage
        async function uploadJSON(file, strategy) {
            const fileName = `positions_${strategy}_${Date.now()}.json`;
            
            const { data, error } = await supabase.storage
                .from('json-positions')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (error) {
                console.error('Erro no upload JSON:', error);
                throw error;
            }
            
            const { data: urlData } = supabase.storage
                .from('json-positions')
                .getPublicUrl(fileName);
            
            return urlData.publicUrl;
        }

        // Salvar dados JSON no Supabase
        async function saveJSONPositions(strategy, file) {
            try {
                const fileUrl = await uploadJSON(file, strategy);
                
                const jsonData = {
                    strategy: strategy,
                    file_url: fileUrl,
                    file_name: file.name,
                    file_size: file.size,
                    updated_at: new Date().toISOString()
                };
                
                // Deletar existente da mesma estrat√©gia
                await supabase
                    .from('json_positions')
                    .delete()
                    .eq('strategy', strategy);
                
                // Inserir novo
                const { data, error } = await supabase
                    .from('json_positions')
                    .insert(jsonData);
                
                if (error) throw error;
                
                return true;
                
            } catch (error) {
                console.error('Erro ao salvar JSON:', error);
                throw error;
            }
        }

        // Listar arquivos JSON
        async function loadJSONFilesList() {
            try {
                const { data: jsonFiles, error } = await supabase
                    .from('json_positions')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('jsonFilesList');
                
                const strategyNames = {
                    'quant': 'Monalisa Quant',
                    'opcoes': 'Monalisa Op√ß√µes',
                    'longshort': 'Monalisa Long & Short'
                };
                
                if (!jsonFiles || jsonFiles.length === 0) {
                    container.innerHTML = '<p style="color: #888;">Nenhum arquivo JSON carregado</p>';
                    return;
                }
                
                container.innerHTML = jsonFiles.map(file => `
                    <div class="json-file-item">
                        <div class="json-file-info">
                            <div class="json-file-strategy">
                                ${strategyNames[file.strategy] || file.strategy}
                                ${file.file_size ? `(${(file.file_size / 1024).toFixed(1)} KB)` : ''}
                            </div>
                            <div class="json-file-date">
                                üìÖ ${new Date(file.updated_at).toLocaleDateString('pt-BR')} √†s 
                                ${new Date(file.updated_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                        <div class="json-file-actions">
                            <button class="btn-generate" onclick="viewJSONFile('${file.file_url}')">
                                üëÅÔ∏è Visualizar
                            </button>
                            <button class="btn-delete" onclick="removeJSONFile('${file.id}', '${file.file_url}')">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista JSON:', error);
            }
        }

        // Visualizar arquivo JSON
        window.viewJSONFile = function(fileUrl) {
            window.open(fileUrl, '_blank');
        }

        // Remover arquivo JSON
        window.removeJSONFile = async function(id, fileUrl) {
            if (!checkAuth()) {
                alert('Sess√£o expirada');
                logout();
                return;
            }
            
            if (!confirm('Excluir este arquivo JSON permanentemente?')) return;
            
            try {
                const fileName = fileUrl.split('/').pop();
                
                if (fileName) {
                    await supabase.storage
                        .from('json-positions')
                        .remove([fileName]);
                }
                
                const { error } = await supabase
                    .from('json_positions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadJSONFilesList();
            } catch (error) {
                console.error('Erro ao deletar JSON:', error);
                alert('Erro ao excluir arquivo JSON');
            }
        }

        // Enviar formul√°rio JSON
        document.getElementById('jsonUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkAuth()) {
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                logout();
                return;
            }
            
            const submitBtn = document.getElementById('jsonSubmitBtn');
            const errorMsg = document.getElementById('jsonErrorMessage');
            const successMsg = document.getElementById('jsonSuccessMessage');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            try {
                const file = document.getElementById('jsonFile').files[0];
                if (!file) throw new Error('Selecione um arquivo JSON');
                
                const strategy = document.querySelector('input[name="jsonStrategy"]:checked').value;
                
                await saveJSONPositions(strategy, file);
                
                successMsg.style.display = 'block';
                this.reset();
                document.getElementById('jsonFileLabel').classList.remove('json-file-selected');
                document.querySelector('.json-file-upload-text').innerHTML = 
                    'üìÑ Clique ou arraste o JSON aqui<small>Aceita apenas arquivos JSON at√© 5MB</small>';
                
                // Remover sele√ß√£o das estrat√©gias
                document.querySelectorAll('.json-strategy-option').forEach(opt => opt.classList.remove('selected'));
                
                await loadJSONFilesList();
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Erro:', error);
                errorMsg.textContent = `Erro: ${error.message}`;
                errorMsg.style.display = 'block';
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publicar Posi√ß√µes';
        });

        
        // Deletar relat√≥rio
        window.removeReport = async function(id, fileUrl) {
            if (!checkAuth()) {
                alert('Sess√£o expirada');
                logout();
                return;
            }
            
            if (!confirm('Excluir este relat√≥rio permanentemente?')) return;
            
            try {
                // Extrair nome do arquivo da URL
                const fileName = fileUrl.split('/').pop();
                
                // Deletar arquivo do storage
                if (fileName) {
                    await supabase.storage
                        .from('reports')
                        .remove([fileName]);
                }
                
                // Deletar do banco
                const { error } = await supabase
                    .from('reports')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadReportsList();
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert('Erro ao excluir relat√≥rio');
            }
        }
        
        // Alterar n√≠vel de acesso
        window.toggleAccess = async function(reportId, currentLevel) {
            if (!checkAuth()) {
                alert('Sess√£o expirada');
                logout();
                return;
            }
            
            const newLevel = currentLevel === 'private' ? 'public' : 'private';
            
            try {
                const { error } = await supabase
                    .from('reports')
                    .update({ 
                        access_level: newLevel,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reportId);
                
                if (error) throw error;
                
                await loadReportsList();
            } catch (error) {
                console.error('Erro ao alterar acesso:', error);
                alert('Erro ao alterar n√≠vel de acesso');
            }
        }
        
        // Manipular arquivo
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('fileLabel');
            const text = label.querySelector('.file-upload-text');
            
            if (file) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                const MAX_SIZE = 30 * 1024 * 1024;
                
                if (file.size > MAX_SIZE) {
                    alert(`Arquivo muito grande! M√°ximo: 30MB\nSeu arquivo: ${sizeMB}MB`);
                    this.value = '';
                    label.classList.remove('file-selected');
                    text.innerHTML = 'üìÑ Clique ou arraste o PDF aqui<small>Aceita apenas arquivos PDF at√© 30MB</small>';
                    return;
                }
                
                label.classList.add('file-selected');
                text.innerHTML = `‚úÖ ${file.name}<small>${sizeMB} MB</small>`;
            } else {
                label.classList.remove('file-selected');
                text.innerHTML = 'üìÑ Clique ou arraste o PDF aqui<small>Aceita apenas arquivos PDF at√© 30MB</small>';
            }
        });
        
        // Enviar formul√°rio
		document.getElementById('uploadForm').addEventListener('submit', async function(e) {
		    e.preventDefault();
		    
		    if (!checkAuth()) {
		        alert('Sess√£o expirada. Fa√ßa login novamente.');
		        logout();
		        return;
		    }
		    
		    const submitBtn = document.getElementById('submitBtn');
		    const errorMsg = document.getElementById('errorMessage');
		    const successMsg = document.getElementById('successMessage');
		    const progressDiv = document.getElementById('uploadProgress');
		    const progressFill = document.getElementById('progressFill');
		    
		    submitBtn.disabled = true;
		    submitBtn.textContent = 'Salvando...';
		    errorMsg.style.display = 'none';
		    successMsg.style.display = 'none';
		    
		    try {
		        const file = document.getElementById('pdfFile').files[0];
		        if (!file) throw new Error('Selecione um arquivo PDF');
		        
		        const accessLevel = document.querySelector('input[name="accessLevel"]:checked').value;
		        
		        const reportData = {
		            type: document.getElementById('reportType').value,
		            title: document.getElementById('reportTitle').value,
		            date: document.getElementById('reportDate').value,
		            summary: document.getElementById('reportSummary').value,
		            accessLevel: accessLevel
		        };
		        
		        await saveReport(reportData, file);
		
		        // Notificar via Brevo sobre novo relat√≥rio
		        try {
		            console.log('Iniciando notifica√ß√µes Brevo...');
		            
		            // Garantir que emailService existe
		            if (!window.emailService && window.BrevoEmailService) {
		                window.emailService = new window.BrevoEmailService();
		                console.log('EmailService inicializado on-demand');
		            }
		            
		            // Buscar assinantes ativos
		            const activeSubscribers = await sheetsService.getActiveSubscribers();
		            
		            if (activeSubscribers && activeSubscribers.length > 0) {
		                console.log(`Enviando notifica√ß√µes para ${activeSubscribers.length} assinantes`);
		                
		                if (window.emailService && typeof window.emailService.sendBatchNotifications === 'function') {
		                    const results = await window.emailService.sendBatchNotifications(
		                        activeSubscribers, 
		                        {
		                            type: reportData.type,
		                            title: reportData.title,
		                            date: reportData.date,
		                            summary: reportData.summary,
		                            access_level: reportData.accessLevel
		                        }
		                    );
		                    
		                    console.log(`Brevo - Notifica√ß√µes: ${results.successful} sucessos, ${results.failed} falhas`);
		                    
		                    if (results.successful > 0) {
		                        setTimeout(() => {
		                            alert(`‚úÖ Relat√≥rio publicado com sucesso!\n\nüìß Notifica√ß√µes enviadas: ${results.successful} de ${results.total} assinantes`);
		                        }, 1000);
		                    } else if (results.failed > 0) {
		                        setTimeout(() => {
		                            alert(`‚ö†Ô∏è Relat√≥rio publicado!\n\nMas houve falha no envio das notifica√ß√µes.\nVerifique o console para detalhes.`);
		                        }, 1000);
		                    }
		                    
		                    if (results.failed > 0 && results.errors.length > 0) {
		                        console.warn('Erros no envio:', results.errors);
		                    }
		                } else {
		                    console.warn('EmailService Brevo n√£o dispon√≠vel');
		                    setTimeout(() => {
		                        alert('‚úÖ Relat√≥rio publicado!\n\n‚ö†Ô∏è Sistema de notifica√ß√µes temporariamente indispon√≠vel.');
		                    }, 1000);
		                }
		            } else {
		                console.log('Nenhum assinante ativo encontrado');
		                setTimeout(() => {
		                    alert('‚úÖ Relat√≥rio publicado!\n\nNenhum assinante ativo para notificar.');
		                }, 1000);
		            }
		        } catch (error) {
		            console.error('Erro ao enviar notifica√ß√µes Brevo:', error);
		            setTimeout(() => {
		                alert('‚úÖ Relat√≥rio publicado!\n\n‚ö†Ô∏è Erro ao enviar notifica√ß√µes: ' + error.message);
		            }, 1000);
		        }
		        
		        successMsg.style.display = 'block';
		        this.reset();
		        document.getElementById('fileLabel').classList.remove('file-selected');
		        document.querySelector('.file-upload-text').innerHTML = 
		            'üìÑ Clique ou arraste o PDF aqui<small>Aceita apenas arquivos PDF at√© 30MB</small>';
		        
		        await loadReportsList();
		        
		        setTimeout(() => {
		            successMsg.style.display = 'none';
		            progressDiv.style.display = 'none';
		            progressFill.style.width = '0%';
		            progressFill.textContent = '0%';
		        }, 3000);
		        
		    } catch (error) {
		        console.error('Erro:', error);
		        errorMsg.textContent = `Erro: ${error.message}`;
		        errorMsg.style.display = 'block';
		        progressDiv.style.display = 'none';
		    }
		    
		    submitBtn.disabled = false;
		    submitBtn.textContent = 'Publicar Relat√≥rio';
		});
		
		// Verificar autentica√ß√£o ao carregar
		window.addEventListener('load', async () => {
		    if (checkAuth()) {
		        document.getElementById('loginContainer').style.display = 'none';
		        document.getElementById('uploadContainer').style.display = 'block';
		        
		        try {
		            // Inicializar Google Sheets Service
		            sheetsService.initialize(GOOGLE_SHEETS_API_KEY);
		            
		            // Carregar dados existentes
		            await loadReportsList();
		            loadAccessCode();
		            await loadJSONFilesList();
		            
		            // Inicializar EmailService para Brevo
		            try {
		                if (typeof BrevoEmailService !== 'undefined') {
		                    window.emailService = new BrevoEmailService();
		                    
		                    // Testar configura√ß√£o Brevo
		                    const testResult = await window.emailService.testConfiguration();
		                    if (testResult.success) {
		                        console.log('EmailService Brevo inicializado no admin com sucesso');
		                        console.log('Endpoints dispon√≠veis:', testResult.endpoints);
		                    } else {
		                        console.warn('Problema na configura√ß√£o Brevo:', testResult.message);
		                        console.warn('Detalhes:', testResult.endpoints);
		                    }
		                } else {
		                    console.warn('BrevoEmailService n√£o encontrado. Verifique se email-service.js foi carregado');
		                }
		            } catch (error) {
		                console.error('Erro ao inicializar Brevo no admin:', error);
		                // N√£o interrompe a aplica√ß√£o se o email falhar
		                window.emailService = null;
		            }
		            
		            console.log('Sistema inicializado com Supabase e Brevo');
		            console.log('Servi√ßos dispon√≠veis:', {
		                supabase: !!supabase,
		                sheetsService: !!sheetsService,
		                emailService: !!window.emailService
		            });
		            
		        } catch (error) {
		            console.error('Erro na inicializa√ß√£o geral:', error);
		            // Ainda permite uso do admin mesmo com erro parcial
		            alert('Sistema carregado com funcionalidade limitada. Verifique o console para detalhes.');
		        }
		    }
		});

    </script>
</body>

</html>









