<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monalisa Research - Relat√≥rios de Investimentos</title>
	<link rel="icon" type="image/png" href="https://i.ibb.co/6Rx2y7vT/favicom-monalisa-azul.png">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="email-service.js"></script>
        
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0B1426;
            color: white;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background: linear-gradient(135deg, #0B1426 0%, #1a2332 50%, #0B1426 100%);
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(74, 144, 226, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 0;
            position: relative;
            z-index: 100;
            margin-top: 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo img {
            height: 70px;
            filter: drop-shadow(0 0 20px rgba(74, 144, 226, 0.3));
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .last-update {
            padding: 0.5rem 1.5rem;
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 30px;
            font-size: 0.9rem;
            color: #4A90E2;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #4A90E2, #7B68EE);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4);
        }
        
        /* Hero Section */
        .hero {
            text-align: center;
            padding: 4rem 2rem 3rem;
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        
        .hero h1 {
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #4A90E2, #7B68EE, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .hero p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.8;
            max-width: 700px;
            margin: 0 auto;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
            position: relative;
            z-index: 10;
        }
        
        /* Strategy Cards Grid */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 4rem;
        }
        
        .strategy-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .strategy-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--card-color), var(--card-color-2));
        }
        
        .card-brasil { --card-color: #27AE60; --card-color-2: #2ECC71; }
        .card-global { --card-color: #E74C3C; --card-color-2: #C0392B; }
        .card-quant { --card-color: #3498DB; --card-color-2: #2980B9; }
        .card-opcoes { --card-color: #F39C12; --card-color-2: #E67E22; }
        .card-longshort { --card-color: #9B59B6; --card-color-2: #8E44AD; }
        .card-graficos { --card-color: #1ABC9C; --card-color-2: #16A085; }
        .card-rendafixa { --card-color: #34495E; --card-color-2: #2C3E50; }
	.card-vectordi { --card-color: #00BFA5; --card-color-2: #00897B; }
	.card-insights { --card-color: #E67E22; --card-color-2: #D35400; }
        
        .strategy-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--card-color), var(--card-color-2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff, rgba(255, 255, 255, 0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-subtitle {
            color: var(--card-color);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
        }
        
        .card-description {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        .card-footer {
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .update-info {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-view-pdf {
            background: linear-gradient(135deg, var(--card-color), var(--card-color-2));
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            position: relative;
        }
        
        .btn-view-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-view-pdf:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-view-pdf .lock-icon {
            display: inline-block;
            margin-right: 5px;
        }
        
        /* Social Share Section */
        .social-share-section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            margin-top: 1rem;
            align-items: center;
            gap: 15px;
        }
        
        .social-share-section.active {
            display: flex;
        }
        
        .share-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .social-share-buttons {
            display: flex;
            gap: 10px;
            flex: 1;
            justify-content: flex-start;
        }
        
        .share-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .share-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        
        .share-btn:hover::before {
            transform: translateY(0);
        }
        
        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .share-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .share-linkedin {
            background: #0077B5;
            color: white;
        }
        
        .share-facebook {
            background: #1877F2;
            color: white;
        }
        
        .share-instagram {
            background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045);
            color: white;
        }
        
        /* Highlight Positions Section */
        .highlight-positions {
            margin: 4rem 0;
            position: relative;
            z-index: 10;
        }
        
        .highlight-positions h2 {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.8rem;
            opacity: 0.9;
        }
        
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .position-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .position-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--position-color), var(--position-color-2));
        }
        
        .position-card.quant { --position-color: #3498DB; --position-color-2: #2980B9; }
        .position-card.opcoes { --position-color: #F39C12; --position-color-2: #E67E22; }
        .position-card.longshort { --position-color: #9B59B6; --position-color-2: #8E44AD; }
        
        .position-card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .position-strategy {
            color: var(--position-color);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .position-symbol {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }
        
        .position-return {
            text-align: right;
        }
        
        .return-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        
        .return-value.positive {
            color: #2ECC71;
        }
        
        .return-value.negative {
            color: #E74C3C;
        }
        
        .return-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }
        
        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }
        
        .position-progress {
            margin-top: 1rem;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--position-color), var(--position-color-2));
            transition: width 0.8s ease;
            border-radius: 3px;
        }
        
       
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Access Code Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-content h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .code-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }
        
        .code-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-modal {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-cancel {
            background: #e0e0e0;
            color: #666;
        }
        
        .btn-cancel:hover {
            background: #d0d0d0;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        /* Footer */
        .footer {
            background: linear-gradient(180deg, #0B1426 0%, #1a2332 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 6rem;
            position: relative;
            z-index: 10;
            padding: 4rem 0 2rem;
        }
        
        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .footer-main {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
            align-items: start;
        }
        
        .footer-logo-section {
            display: flex;
            align-items: center;
        }
        
        .apimec-logo {
            width: 120px;
            height: auto;
            opacity: 0.8;
        }
        
        .footer-legal {
            border-left: 3px solid #F39C12;
            padding-left: 2rem;
        }
        
        .footer-legal h3 {
            color: #F39C12;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .footer-legal p {
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
            font-size: 0.85rem;
            text-align: justify;
        }
        
        .footer-legal p strong {
            color: #F39C12;
            display: block;
            margin-top: 1rem;
            font-style: italic;
        }
        
        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 2rem;
            text-align: center;
        }
        
        .footer-copyright {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.85rem;
        }
        
        /* Responsive Footer */
        @media (max-width: 968px) {
            .footer-main {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .footer-logo-section {
                justify-content: center;
            }
            
            .footer-legal {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding-left: 0;
                padding-top: 2rem;
            }
        }
        
        /* SUBSTITUIR TODAS AS MEDIA QUERIES EXISTENTES POR ESTE CSS */

		/* Melhorar responsividade APENAS para tablets - Desktop mantido como estava */
		@media (max-width: 1024px) and (min-width: 769px) {
		   .strategies-grid {
		       grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		       gap: 1.5rem;
		   }
		   
		   .nav-container {
		       padding: 0 1rem;
		   }
		   
		   .header-actions {
		       flex-direction: column;
		       gap: 0.5rem;
		       align-items: stretch;
		   }
		   
		   .last-update {
		       font-size: 0.8rem;
		       padding: 0.4rem 1rem;
		   }
		   
		   .refresh-btn {
		       padding: 0.7rem 1.5rem;
		       font-size: 0.85rem;
		   }
		   
		   .social-share-section {
		       flex-direction: row;
		       align-items: center;
		       padding: 12px;
		   }
		   
		   .social-share-buttons {
		       gap: 8px;
		   }
		   
		   .share-btn {
		       width: 34px;
		       height: 34px;
		       font-size: 16px;
		   }
		}

		/* Responsividade APENAS mobile - Desktop e tablet mantidos */
		@media (max-width: 768px) {
		   .strategies-grid {
		       grid-template-columns: 1fr;
		       gap: 1rem;
		   }
		   
		   /* Ajustar grid espec√≠fico do bloco An√°lise de Mercado */
		   .container .strategies-grid[style*="minmax(400px, 1fr)"] {
		       grid-template-columns: 1fr !important;
		   }
		   
		   .strategy-card {
		       padding: 1.5rem;
		   }
		   
		   .card-title {
		       font-size: 1.5rem;
		   }
		   
		   .card-footer-content {
		       flex-direction: column;
		       align-items: stretch;
		       gap: 1rem;
		   }
		   
		   .btn-view-pdf {
		       width: 100%;
		       text-align: center;
		   }

			.social-share-section {
			    flex-direction: column;
			    align-items: center;
			    gap: 10px;
			    padding: 15px 12px;
			}
			
			.social-share-section.active {
			    display: flex;  /* Manter a regra da classe active */
			}
		   
		   .social-share-buttons {
		       justify-content: center;
		       flex-wrap: wrap;
		       gap: 12px;
		   }
		   
		   .share-btn {
		       width: 40px;
		       height: 40px;
		       font-size: 20px;
		   }
		   
		   .share-label {
		       text-align: center;
		       margin-bottom: 5px;
		   }
		   
		   .hero {
		       padding: 3rem 1rem 2rem;
		   }
		   
		   .hero p {
		       font-size: 1rem;
		   }
		   
		   .container {
		       padding: 0 1rem 4rem;
		   }
		   
		   .positions-grid {
		       grid-template-columns: 1fr;
		       gap: 1rem;
		   }
		   
		   .position-card {
		       padding: 1.5rem;
		   }
		   
		   .position-header {
		       flex-direction: column;
		       align-items: flex-start;
		       gap: 1rem;
		   }
		   
		   .position-return {
		       text-align: left;
		       width: 100%;
		   }
		   
		   /* Modal responsivo */
		   .modal-content {
		       width: 95%;
		       padding: 30px 20px;
		       margin: 0 10px;
		   }
		   
		   .modal-buttons {
		       flex-direction: column;
		       gap: 10px;
		   }
		   
		   .btn-modal {
		       width: 100%;
		   }
		   
		   .code-input {
		       font-size: 16px; /* Evita zoom no iOS */
		   }
		   
		   /* Melhorar espa√ßamento em cards quando empilhados */
		   .strategies-grid + hr {
		       margin: 2rem 0 !important;
		   }
		   
		   h2[style*="text-align: center"] {
		       margin-bottom: 1.5rem !important;
		       font-size: 1.5rem !important;
		   }
		}

        /* Responsividade para telas muito pequenas APENAS */
        @media (max-width: 480px) {
            .logo img {
                height: 50px;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-actions {
                width: 100%;
            }
            
            .last-update,
            .refresh-btn {
                width: 100%;
                text-align: center;
            }
            
            .hero h1 {
                font-size: clamp(1.8rem, 8vw, 2.5rem);
                line-height: 1.2;
            }
            
            .strategy-card {
                padding: 1rem;
                border-radius: 16px;
            }
            
            .card-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .card-subtitle {
                font-size: 0.8rem;
            }
            
            .position-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: left;
            }
            
            .detail-item {
                text-align: left;
                padding: 0.5rem 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .detail-item:last-child {
                border-bottom: none;
            }
        }

        /* Corre√ß√£o para landscape em dispositivos m√≥veis APENAS */
        @media (max-height: 500px) and (orientation: landscape) and (max-width: 1024px) {
            .hero {
                padding: 2rem 1rem 1rem;
            }
            
            .hero h1 {
                font-size: 2rem;
                margin-bottom: 1rem;
            }
            
            .hero p {
                font-size: 0.9rem;
            }
            
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Corre√ß√£o para evitar overflow horizontal APENAS em mobile */
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                width: 100%;
            }

            .container,
            .nav-container,
            .footer-container {
                max-width: 100%;
                overflow-x: hidden;
            }
        }

        /* Footer responsivo - mant√©m desktop como estava */
        @media (max-width: 968px) {
            .footer-main {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .footer-logo-section {
                justify-content: center;
            }
            
            .footer-legal {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding-left: 0;
                padding-top: 2rem;
            }
        }
		
	

        /* ADICIONAR NO FINAL DO CSS EXISTENTE */
        .auth-step {
            animation: slideIn 0.3s ease;
        }

        .loading-indicator {
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4A90E2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }



    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    

    <!-- Modal de Autentica√ß√£o por CPF -->
    <div class="modal" id="cpfAuthModal">
        <div class="modal-content">
            <div id="authStep1" class="auth-step">
                <h2>Conte√∫do Exclusivo</h2>
                <p>Este relat√≥rio √© exclusivo para assinantes. Digite seu CPF para continuar:</p>
                <input type="text" 
                      class="code-input" 
                      id="cpfAuthInput" 
                      placeholder="000.000.000-00" 
                      maxlength="14">
                <div class="error-message" id="cpfAuthError"></div>
                <div class="modal-buttons">
                    <button class="btn-modal btn-cancel" onclick="closeCPFAuthModal()">Cancelar</button>
                    <button class="btn-modal btn-confirm" onclick="validateCPFAndSendCode()">Continuar</button>
                </div>
            </div>
            
            <div id="authStep2" class="auth-step" style="display: none;">
                <h2>C√≥digo Enviado!</h2>
                <p>Enviamos um c√≥digo de acesso para o email cadastrado:</p>
                <p id="maskedEmail" style="font-weight: bold; color: #4A90E2;"></p>
                <input type="text" 
                      class="code-input" 
                      id="emailCodeInput" 
                      placeholder="000000" 
                      maxlength="6">
                <div class="error-message" id="emailCodeError"></div>
                <div class="modal-buttons">
                    <button class="btn-modal btn-cancel" onclick="backToStep1()">Voltar</button>
                    <button class="btn-modal btn-confirm" onclick="validateEmailCode()">Confirmar</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 15px;">
                    N√£o recebeu? Verifique a pasta de spam ou aguarde alguns minutos.
                </p>
            </div>
            
            <div id="authStep3" class="auth-step" style="display: none;">
                <h2>‚úÖ Acesso Liberado!</h2>
                <p>C√≥digo validado com sucesso. Redirecionando...</p>
                <div class="loading-indicator">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <img src="https://i.postimg.cc/ZYf8MfJf/Logo-1-Branco.png" alt="Monalisa Research">
            </div>
            <div class="header-actions">
                <span class="last-update" id="lastUpdate">
                    Atualizado: --/--/----
                </span>
                <button class="refresh-btn" onclick="checkForUpdates()">
                    Verificar Atualiza√ß√µes
                </button>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <div class="hero">
        <h1>Relat√≥rios de Investimento</h1>
        <p>An√°lises quantitativas alimentadas por IA para maximizar seus retornos. 
           Estrat√©gias personalizadas para cada perfil de investidor.</p>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Bloco: Carteiras Recomendadas e Estrat√©gias de Trading -->
        <h2 style="color: white; text-align: center; margin-bottom: 2rem; font-size: 1.8rem; opacity: 0.9;">
            Carteiras Recomendadas e Estrat√©gias de Trading
        </h2>
        
        <!-- Strategy Cards -->
        <div class="strategies-grid">
            <!-- Monalisa Brasil -->
            <div class="strategy-card card-brasil">
                <div class="card-icon">üáßüá∑</div>
                <h2 class="card-title">Monalisa Brasil</h2>
                <div class="card-subtitle">A√ß√µes Brasileiras B3</div>
                <p class="card-description">
                    Carteira quantitativa de a√ß√µes brasileiras com machine learning. 
                    Sele√ß√£o mensal otimizada de 10 ativos com gest√£o de risco din√¢mica.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateBrasil" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportBrasil">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnBrasil" onclick="viewStrategy('brasil')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareBrasil">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monalisa Global -->
            <div class="strategy-card card-global">
                <div class="card-icon">üåç</div>
                <h2 class="card-title">Monalisa Global</h2>
                <div class="card-subtitle">A√ß√µes Globais SP500</div>
                <p class="card-description">
                    Portfolio internacional com as melhores oportunidades do S&P 500. 
                    Diversifica√ß√£o setorial global com algoritmos avan√ßados.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateGlobal" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportGlobal">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnGlobal" onclick="viewStrategy('global')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareGlobal">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monalisa Quant -->
            <div class="strategy-card card-quant">
                <div class="card-icon">üìä</div>
                <h2 class="card-title">Monalisa Quant</h2>
                <div class="card-subtitle">Swing & Position Trading</div>
                <p class="card-description">
                    Opera√ß√µes de swing e position trading com Random Forest. 
                    Sinais Long/Short com gest√£o de risco e stops din√¢micos.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateQuant" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportQuant">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnQuant" onclick="viewStrategy('quant')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareQuant">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monalisa Op√ß√µes -->
            <div class="strategy-card card-opcoes">
                <div class="card-icon">üéØ</div>
                <h2 class="card-title">Monalisa Op√ß√µes</h2>
                <div class="card-subtitle">Multi-Estrat√©gias com Op√ß√µes</div>
                <p class="card-description">
                    An√°lise automatizada de spreads, butterflies e BOX. 
                    Identifica√ß√£o de arbitragens e distor√ß√µes com Black-Scholes.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateOpcoes" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportOpcoes">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnOpcoes" onclick="viewStrategy('opcoes')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareOpcoes">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monalisa Long and Short -->
            <div class="strategy-card card-longshort">
                <div class="card-icon">üìà</div>
                <h2 class="card-title">Monalisa Long/Short</h2>
                <div class="card-subtitle">Opera√ß√µes Long/Short</div>
                <p class="card-description">
                    O Sistema Monalisa Long/Short aplica an√°lise quantitativa avan√ßada 
		    para identificar pares de ativos cointegrados em a√ß√µes listadas na bolsa. 
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateLongshort" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportLongshort">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnLongshort" onclick="viewStrategy('longshort')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareLongshort">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>

            <!-- Monalisa Vector DI -->
            <div class="strategy-card card-vectordi">
                <div class="card-icon">üìä</div>
                <h2 class="card-title">Monalisa Vector DI</h2>
                <div class="card-subtitle">Gest√£o Ativa de Renda Fixa</div>
                <p class="card-description">
                    Gest√£o ativa de carteiras de Renda Fixa com foco em T√≠tulos P√∫blicos. 
                    Machine Learning para antecipar movimentos na curva de juros.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateVectordi" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportVectordi">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnVectordi" onclick="viewStrategy('vectordi')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareVectordi">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Linha divis√≥ria suave -->
        <hr style="border: 0; height: 1px; background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent); margin: 4rem 0;">
        
        <!-- Bloco: An√°lise de Mercado -->
        <h2 style="color: white; text-align: center; margin-bottom: 2rem; font-size: 1.8rem; opacity: 0.9;">
            An√°lise de Mercado
        </h2>
        
        <div class="strategies-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 4rem;">
            <!-- Gr√°ficos em A√ß√£o -->
            <div class="strategy-card card-graficos">
                <div class="card-icon">üìâ</div>
                <h2 class="card-title">Gr√°ficos em A√ß√£o</h2>
                <div class="card-subtitle">An√°lise T√©cnica</div>
                <p class="card-description">
                    O mercado financeiro sob a √≥tica da an√°lise gr√°fica.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateGraficos" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportGraficos">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnGraficos" onclick="viewStrategy('graficos')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareGraficos">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
            
            <!-- De Olho na Renda Fixa -->
            <div class="strategy-card card-rendafixa">
                <div class="card-icon">üí∞</div>
                <h2 class="card-title">De Olho na Renda Fixa</h2>
                <div class="card-subtitle">Renda Fixa</div>
                <p class="card-description">
                    Acompanhe o que de fato interessa no mercado de Renda Fixa.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateRendafixa" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportRendafixa">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnRendafixa" onclick="viewStrategy('rendafixa')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareRendafixa">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>

            <!-- Monalisa Insights -->
            <div class="strategy-card card-insights">
                <div class="card-icon">üìä</div>
                <h2 class="card-title">Monalisa Insights</h2>
                <div class="card-subtitle">An√°lise de Mercado</div>
                <p class="card-description">
                    Fique por dentro do que aconteceu no Mercado Financeiro.
                </p>
                <div class="card-footer">
                    <div class="card-footer-content">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.3rem;">
                            <span class="update-info" id="updateInsights" style="font-size: 0.75rem; opacity: 0.7;">Sem dados</span>
                            <span style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.5);" id="lastReportInsights">
                                √öltimo relat√≥rio: --/--/----
                            </span>
                        </div>
                        <button class="btn-view-pdf" id="btnInsights" onclick="viewStrategy('insights')" disabled>
                            Ver Relat√≥rio
                        </button>
                    </div>
                    <div class="social-share-section" id="shareInsights">
                        <span class="share-label">Compartilhar:</span>
                        <div class="social-share-buttons"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Posi√ß√µes em Destaque -->
        <div class="highlight-positions" id="highlightPositions" style="display: none;">
            <hr style="border: 0; height: 1px; background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent); margin: 4rem 0 2rem;">
            
            <h2>üöÄ Posi√ß√µes em Destaque</h2>
            <p style="text-align: center; color: rgba(255, 255, 255, 0.6); margin-bottom: 3rem;">
                Alguns resultados das nossas estrat√©gias quantitativas
            </p>
            
            <div class="positions-grid" id="positionsGrid">
                <!-- Cards de posi√ß√µes ser√£o inseridos aqui via JavaScript -->
            </div>
        </div>  

    </div>
    
    <!-- Footer com Aviso Legal -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-main">
                <div class="footer-logo-section">
                    <img src="https://i.postimg.cc/vTXS5MGn/APIMEC-Brasil-selo-de-credenciamento-pessoa-juridica.png" 
                         alt="APIMEC Brasil" 
                         class="apimec-logo">
                </div>
                
                <div class="footer-legal">
                    <h3>Aviso Importante</h3>
                    <p>
                        As an√°lises publicadas pela Monalisa Research (raz√£o social: Monalisa Trading Research ‚Äì 
                        CNPJ 59.932.253/0001-46) est√£o sob a responsabilidade do analista Antonio Carlos Martins 
                        de Siqueira, CNPI-T 7131. O conte√∫do das an√°lises n√£o pode ser reproduzido ou distribu√≠do, 
                        no todo ou em parte, a qualquer terceiro sem autoriza√ß√£o expressa. As decis√µes de 
                        investimentos e estrat√©gias financeiras devem ser realizadas pelos pr√≥prios leitores. 
                        As an√°lises n√£o representam ofertas, negocia√ß√£o de valores mobili√°rios ou outros 
                        instrumentos financeiros, e se alicer√ßam no mais alto padr√£o √©tico, de independ√™ncia 
                        e autonomia seguidas pelas diretrizes da Resolu√ß√£o CVM 20/2021 e no C√≥digo de Conduta 
                        da Apimec para o Analista de Valores Mobili√°rios.
                        <strong>"Resultado passado n√£o √© garantia de resultado futuro!"</strong>
                    </p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p class="footer-copyright">
                    Copyright ¬© 2025 Monalisa Research. Todos os direitos reservados.
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Sistema de banco de dados
        let availableReports = {};
        let pendingReportType = null;
        let positionsData = {};
        
        // Verificar c√≥digo de acesso salvo
        function hasValidAccess() {
            const savedCode = localStorage.getItem('subscriberCode');
            const codeTimestamp = localStorage.getItem('codeTimestamp');
            
            if (savedCode && codeTimestamp) {
                const daysSinceCode = (Date.now() - parseInt(codeTimestamp)) / (1000 * 60 * 60 * 24);
                if (daysSinceCode < 30) {
                    return true;
                }
            }
            return false;
        }

		// Fun√ß√£o para criar bot√µes de compartilhamento - MANTER COMO EST√Å
		function createShareButtons(type, title) {
		    const report = availableReports[type];
		    const session = getLocalSession();
		    const userAccess = session ? session.accessLevel : getUserAccessLevel('INVESTIDOR');
		    
		    // Verificar se √© relat√≥rio privado
		    const isPrivate = report && report.access_level === 'private';
		    
		    // Determinar URL para compartilhar
		    let shareUrl;
		    
		    if (isPrivate) {
		        // RELAT√ìRIO PRIVADO
		        if (session && (userAccess.level === 'FULL_ACCESS' || userAccess.level === 'PROFESSIONAL')) {
		            // RESEARCH ou ASSESSOR: criar link de compartilhamento
		            const pdfUrl = encodeURIComponent(report.file_url);
		            const shareTitle = encodeURIComponent(title);
		            // Usar p√°gina intermedi√°ria para melhor preview
		            shareUrl = encodeURIComponent(`${window.location.origin}/share.html?pdf=${pdfUrl}&title=${shareTitle}`);
		        } else {
		            // INVESTIDOR ou n√£o logado: N√ÉO PODE compartilhar privado
		            return '';
		        }
		    } else {
		        // RELAT√ìRIO P√öBLICO: todos podem compartilhar
		        if (report && report.file_url) {
		            const pdfUrl = encodeURIComponent(report.file_url);
		            const shareTitle = encodeURIComponent(title);
		            // Usar p√°gina intermedi√°ria para melhor preview
		            shareUrl = encodeURIComponent(`${window.location.origin}/share.html?pdf=${pdfUrl}&title=${shareTitle}`);
		        } else {
		            shareUrl = encodeURIComponent(window.location.href);
		        }
		    }
		    
		    const shareText = encodeURIComponent(`üìä Relat√≥rio ${title} - Monalisa Research\n\nüí° An√°lise quantitativa de investimentos com IA`);
		    
		    return `
		        <a href="https://api.whatsapp.com/send?text=${shareText}%20${shareUrl}" 
		           target="_blank" 
		           class="share-btn share-whatsapp" 
		           title="Compartilhar no WhatsApp">
		            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
		                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
		                <path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2.546 20.2A1.01 1.01 0 0 0 3.8 21.454l3.032-.892A9.957 9.957 0 0 0 12 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.657 0-3.197-.504-4.473-1.355l-.327-.196-2.4.705.705-2.4-.196-.327A7.956 7.956 0 0 1 4 12c0-4.418 3.582-8 8-8s8 3.582 8 8-3.582 8-8 8z"/>
		            </svg>
		        </a>
		        <a href="https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}" 
		           target="_blank" 
		           class="share-btn share-linkedin" 
		           title="Compartilhar no LinkedIn">
		            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
		                <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
		            </svg>
		        </a>
		        <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}" 
		           target="_blank" 
		           class="share-btn share-facebook" 
		           title="Compartilhar no Facebook">
		            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
		                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
		            </svg>
		        </a>
		        <a href="#" 
		           onclick="shareOnInstagram('${type}'); return false;" 
		           class="share-btn share-instagram" 
		           title="Copiar link para Instagram">
		            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
		                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.405a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
		            </svg>
		        </a>
		    `;
		}
        
		// Fun√ß√£o para compartilhar no Instagram (apenas copiar link)
		function shareOnInstagram(type) {
		    const report = availableReports[type];
		    const session = getLocalSession();
		    const userAccess = session ? session.accessLevel : getUserAccessLevel('INVESTIDOR');
		    const isPrivate = report && report.access_level === 'private';
		    
		    let url;
		    
		    if (isPrivate) {
		        // Privado: s√≥ RESEARCH/ASSESSOR podem compartilhar
		        if (session && (userAccess.level === 'FULL_ACCESS' || userAccess.level === 'PROFESSIONAL')) {
		            url = report.file_url;
		        } else {
		            return; // N√£o deveria chegar aqui
		        }
		    } else {
		        // P√∫blico: todos podem compartilhar
		        url = report && report.file_url ? report.file_url : window.location.href;
		    }
		    
		    navigator.clipboard.writeText(url).then(() => {
		        alert('Link do PDF copiado! Cole-o no seu story ou publica√ß√£o do Instagram.');
		    });
		}
        
        // Fun√ß√£o para buscar dados JSON das posi√ß√µes
        async function getJSONPositions() {
            try {
                const { data, error } = await supabase
                    .from('json_positions')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao buscar posi√ß√µes JSON:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('Erro:', error);
                return [];
            }
        }

        // Fun√ß√£o para processar dados de posi√ß√µes dos arquivos JSON
        async function processPositionsData() {
            const positionsContainer = document.getElementById('positionsGrid');
            const highlightSection = document.getElementById('highlightPositions');
            let hasPositions = false;
            let allPositions = [];
            
            try {
                const jsonFiles = await getJSONPositions();
                
                if (jsonFiles.length === 0) {
                    highlightSection.style.display = 'none';
                    return;
                }
                
                let processedFiles = 0;
                
                // Processar cada arquivo JSON
                for (const jsonFile of jsonFiles) {
                    try {
                        const response = await fetch(jsonFile.file_url);
                        const data = await response.json();
                        
                        const positions = extractPositionsFromJson(data, jsonFile.strategy);
                        if (positions.length > 0) {
                            allPositions = allPositions.concat(positions);
                            hasPositions = true;
                        }
                        
                        processedFiles++;
                        
                        // Quando todos os arquivos foram processados, atualizar display
                        if (processedFiles === jsonFiles.length) {
                            if (hasPositions) {
                                updatePositionsDisplay(allPositions);
                            } else {
                                highlightSection.style.display = 'none';
                            }
                        }
                        
                    } catch (error) {
                        console.error(`Erro ao carregar arquivo JSON ${jsonFile.strategy}:`, error);
                        processedFiles++;
                        
                        // Mesmo com erro, verificar se terminou de processar
                        if (processedFiles === jsonFiles.length) {
                            if (hasPositions) {
                                updatePositionsDisplay(allPositions);
                            } else {
                                highlightSection.style.display = 'none';
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Erro ao processar posi√ß√µes:', error);
                highlightSection.style.display = 'none';
            }
        }

		// Extrair posi√ß√µes dos dados JSON
		function extractPositionsFromJson(data, strategy) {
		    let positions = [];
		    
		    try {
		        if (strategy === 'quant') {
		            // Monalisa Quant - formato array simples
		            if (Array.isArray(data)) {
		                positions = data.map(pos => ({
		                    strategy: 'Monalisa Quant',
		                    strategyType: 'quant',
		                    symbol: pos.codigo,
		                    returnPercent: pos.variacao_pct,
		                    entryPrice: pos.preco_entrada,
		                    currentPrice: pos.ultimo_preco,
		                    entryDate: pos.data_entrada,
		                    takeProfit: pos.take_profit,
		                    stopLoss: pos.stop_loss,
		                    status: pos.status,
		                    daysOpen: calculateDaysOpen(pos.data_entrada),
		                    startDate: pos.data_entrada,
		                    analysisDate: data.metadata?.data_atualizacao?.split('T')[0] || new Date().toISOString().split('T')[0]
		                }));
		            }
		        }
		        else if (strategy === 'opcoes') {
		            // Monalisa Op√ß√µes - formato complexo
		            if (data.posicoes_por_ativo) {
		                Object.entries(data.posicoes_por_ativo).forEach(([ativo, info]) => {
		                    info.estrategias.forEach(est => {
		                        positions.push({
		                            strategy: 'Monalisa Op√ß√µes',
		                            strategyType: 'opcoes',
		                            symbol: ativo,
		                            returnPercent: est.rentabilidade_percentual,
		                            returnAbsolute: est.rentabilidade_absoluta,
		                            investment: est.investimento_entrada,
		                            currentValue: est.valor_atual,
		                            strategyName: est.nome_estrategia,
		                            expiration: est.vencimento,
		                            daysToExpiry: est.dias_ate_vencimento,
		                            breakevens: est.breakevens,
		                            spotPrice: info.preco_spot_atual,
		                            daysOpen: calculateDaysOpen(est.data_abertura.split('T')[0]),
		                            startDate: est.data_abertura.split('T')[0],
		                            analysisDate: data.metadata?.data_atualizacao?.split('T')[0] || new Date().toISOString().split('T')[0]
		                        });
		                    });
		                });
		            }
		        }
		        else if (strategy === 'longshort') {
		            // Monalisa Long/Short - formato pairs
		            if (data.active_positions && Array.isArray(data.active_positions)) {
		                positions = data.active_positions.map(pos => {
		                    const returnCalc = calculatePairReturn(pos);
		                    return {
		                        strategy: 'Long/Short',
		                        strategyType: 'longshort',
		                        symbol: pos.pair,
		                        tickerA: pos.ticker_a,
		                        tickerB: pos.ticker_b,
		                        signalType: pos.signal_type,
		                        zscore: pos.current_zscore,
		                        entryRatio: pos.entry_ratio,
		                        currentRatio: pos.price_a / pos.price_b,
		                        targetRatio: pos.target_ratio,
		                        qualityScore: pos.quality_score,
		                        returnPercent: returnCalc.percent,
		                        hedgeRatio: pos.hedge_ratio,
		                        entryDate: pos.entry_date,
		                        daysOpen: calculateDaysOpen(pos.entry_date),
		                        operations: pos.operations,
		                        startDate: pos.entry_date,
		                        analysisDate: data.metadata?.data_atualizacao?.split('T')[0] || new Date().toISOString().split('T')[0]
		                    };
		                });
		            }
		        }
		    } catch (error) {
		        console.error(`Erro ao processar dados de ${strategy}:`, error);
		    }
		    
		    return positions;
		}
        
        // Calcular dias em aberto
        function calculateDaysOpen(entryDate) {
            const entry = new Date(entryDate);
            const today = new Date();
            const diffTime = Math.abs(today - entry);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // Calcular retorno para pairs trading
        function calculatePairReturn(position) {
            const currentRatio = position.price_a / position.price_b;
            const entryRatio = position.entry_ratio;
            
            if (position.signal_type === 'LONG') {
                const returnPercent = ((currentRatio / entryRatio) - 1) * 100;
                return { percent: returnPercent };
            } else {
                const returnPercent = ((entryRatio / currentRatio) - 1) * 100;
                return { percent: returnPercent };
            }
        }
        
        // Atualizar display das posi√ß√µes
        function updatePositionsDisplay(allPositions) {
            const positionsContainer = document.getElementById('positionsGrid');
            const highlightSection = document.getElementById('highlightPositions');
            
            // Agrupar posi√ß√µes por estrat√©gia
            const positionsByStrategy = {
                'quant': [],
                'opcoes': [],
                'longshort': []
            };
            
            // Organizar posi√ß√µes por estrat√©gia
            allPositions.forEach(pos => {
                if (positionsByStrategy[pos.strategyType]) {
                    positionsByStrategy[pos.strategyType].push(pos);
                }
            });
            
            const topPositions = [];
            
            // Para cada estrat√©gia, pegar a melhor posi√ß√£o
            Object.entries(positionsByStrategy).forEach(([strategy, positions]) => {
                if (positions.length > 0) {
                    // Ordenar: primeiro por retornos positivos (decrescente), depois por menos negativos (crescente do valor absoluto)
                    positions.sort((a, b) => {
                        const returnA = a.returnPercent || 0;
                        const returnB = b.returnPercent || 0;
                        
                        // Se ambos s√£o positivos, maior primeiro
                        if (returnA > 0 && returnB > 0) {
                            return returnB - returnA;
                        }
                        // Se apenas um √© positivo, ele vem primeiro
                        if (returnA > 0 && returnB <= 0) {
                            return -1;
                        }
                        if (returnB > 0 && returnA <= 0) {
                            return 1;
                        }
                        // Se ambos s√£o negativos ou zero, menos negativo primeiro (maior valor)
                        return returnB - returnA;
                    });
                    
                    // Pegar a melhor posi√ß√£o da estrat√©gia
                    topPositions.push(positions[0]);
                }
            });
            
            if (topPositions.length === 0) {
                highlightSection.style.display = 'none';
                return;
            }
            
            // Ordenar as top positions para exibi√ß√£o (melhores retornos primeiro)
            topPositions.sort((a, b) => (b.returnPercent || 0) - (a.returnPercent || 0));
            
            positionsContainer.innerHTML = topPositions.map(pos => createPositionCard(pos)).join('');
            highlightSection.style.display = 'block';
        }

		// Criar card de posi√ß√£o
		function createPositionCard(position) {
		    const returnClass = position.returnPercent > 0 ? 'positive' : 'negative';
		    const progressWidth = Math.min(Math.abs(position.returnPercent || 0), 100);
		    
		    // Para Long/Short, remover .SA dos tickers
		    let displaySymbol = position.symbol;
		    if (position.strategyType === 'longshort' && position.symbol) {
		        displaySymbol = position.symbol.replace(/\.SA/g, '');
		    }
		    
		    // Fun√ß√£o para formatar per√≠odo da opera√ß√£o
		    function formatDatePeriod(startDate, analysisDate) {
		        if (!startDate) return 'N/A';
		        
		        try {
		            const start = new Date(startDate);
		            const analysis = analysisDate ? new Date(analysisDate) : new Date();
		            
		            const formatDate = (date) => {
		                if (isNaN(date.getTime())) return 'N/A';
		                return date.toLocaleDateString('pt-BR', {
		                    day: '2-digit',
		                    month: '2-digit',
		                    year: '2-digit'
		                });
		            };
		            
		            return `${formatDate(start)} - ${formatDate(analysis)}`;
		        } catch (error) {
		            console.error('Erro ao formatar datas:', error);
		            return 'N/A';
		        }
		    }
		    
		    let detailsSection = '';
		    
		    if (position.strategyType === 'quant') {
		        detailsSection = `
		            <div class="position-details">
		                <div class="detail-item">
		                    <div class="detail-label">Entrada</div>
		                    <div class="detail-value">R$ ${position.entryPrice.toFixed(2)}</div>
		                </div>
		                <div class="detail-item">
		                    <div class="detail-label">Atual</div>
		                    <div class="detail-value">R$ ${position.currentPrice.toFixed(2)}</div>
		                </div>
		            </div>
		            <div class="position-details">
		                <div class="detail-item" style="grid-column: 1 / -1; text-align: center; padding-top: 0.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
		                    <div class="detail-label">Per√≠odo da Opera√ß√£o</div>
		                    <div class="detail-value" style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">
		                        ${formatDatePeriod(position.startDate, position.analysisDate)}
		                    </div>
		                </div>
		            </div>
		        `;
		    } else if (position.strategyType === 'opcoes') {
		        detailsSection = `
		            <div class="position-details">
		                <div class="detail-item">
		                    <div class="detail-label">Investimento</div>
		                    <div class="detail-value">R$ ${position.investment.toLocaleString('pt-BR')}</div>
		                </div>
		                <div class="detail-item">
		                    <div class="detail-label">Valor Atual</div>
		                    <div class="detail-value">R$ ${position.currentValue.toLocaleString('pt-BR')}</div>
		                </div>
		            </div>
		            <div class="position-details">
		                <div class="detail-item" style="grid-column: 1 / -1; text-align: center; padding-top: 0.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
		                    <div class="detail-label">Per√≠odo da Opera√ß√£o</div>
		                    <div class="detail-value" style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">
		                        ${formatDatePeriod(position.startDate, position.analysisDate)}
		                    </div>
		                </div>
		            </div>
		            ${position.strategyName ? `
		            <div class="position-details" style="margin-top: 0.5rem;">
		                <div class="detail-item" style="grid-column: 1 / -1; text-align: center;">
		                    <div class="detail-label">Estrat√©gia</div>
		                    <div class="detail-value" style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">
		                        ${position.strategyName}
		                    </div>
		                </div>
		            </div>` : ''}
		        `;
		    } else if (position.strategyType === 'longshort') {
		        detailsSection = `
		            <div class="position-details">
		                <div class="detail-item">
		                    <div class="detail-label">Z-Score</div>
		                    <div class="detail-value">${position.zscore.toFixed(2)}</div>
		                </div>
		                <div class="detail-item">
		                    <div class="detail-label">Qualidade</div>
		                    <div class="detail-value">${position.qualityScore}%</div>
		                </div>
		            </div>
		            <div class="position-details">
		                <div class="detail-item" style="grid-column: 1 / -1; text-align: center; padding-top: 0.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
		                    <div class="detail-label">Per√≠odo da Opera√ß√£o</div>
		                    <div class="detail-value" style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">
		                        ${formatDatePeriod(position.startDate, position.analysisDate)}
		                    </div>
		                </div>
		            </div>
		        `;
		    }
		    
		    return `
		        <div class="position-card ${position.strategyType}">
		            <div class="position-header">
		                <div>
		                    <div class="position-strategy">${position.strategy}</div>
		                    <div class="position-symbol">${displaySymbol}</div>
		                </div>
		                <div class="position-return">
		                    <div class="return-value ${returnClass}">
		                        ${position.returnPercent > 0 ? '+' : ''}${position.returnPercent.toFixed(2)}%
		                    </div>
		                    <div class="return-label">Retorno</div>
		                </div>
		            </div>
		            
		            ${detailsSection}
		            
		            <div class="position-progress">
		                <div class="progress-label">
		                    <span>Performance</span>
		                    <span>${position.daysOpen} dias</span>
		                </div>
		                <div class="progress-bar-container">
		                    <div class="progress-bar-fill" style="width: ${progressWidth}%"></div>
		                </div>
		            </div>
		        </div>
		    `;
		}
        
       
        // Buscar todos os relat√≥rios do Supabase
        async function getAllReports() {
            try {
                const { data, error } = await supabase
                    .from('reports')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao buscar relat√≥rios:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('Erro:', error);
                return [];
            }
        }
		
		// Sistema de n√≠veis de acesso
		function getUserAccessLevel(userType) {
		    switch(userType) {
		        case 'RESEARCH': 
		            return {
		                level: 'FULL_ACCESS',
		                canShareAll: true,
		                hasWatermark: false,
		                description: 'Acesso total sem restri√ß√µes'
		            };
		        case 'ASSESSOR':
		            return {
		                level: 'PROFESSIONAL', 
		                canShareAll: true,
		                hasWatermark: true,
		                description: 'Pode compartilhar tudo, mas com marca d\'√°gua'
		            };
		        case 'INVESTIDOR':
		            return {
		                level: 'BASIC',
		                canShareAll: false,
		                hasWatermark: true,
		                description: 'S√≥ pode compartilhar relat√≥rios p√∫blicos'
		            };
		        default:
		            return {
		                level: 'LIMITED',
		                canShareAll: false, 
		                hasWatermark: true,
		                description: 'Acesso limitado'
		            };
		    }
		}
		
		// Verificar se usu√°rio pode acessar relat√≥rio
		function canAccessReport(report, userAccess) {
		    // RESEARCH tem acesso a tudo
		    if (userAccess.level === 'FULL_ACCESS') {
		        return true;
		    }
		    
		    // ASSESSOR e INVESTIDOR seguem regras normais de p√∫blico/privado
		    if (report.access_level === 'private') {
		        return userAccess.level === 'PROFESSIONAL' || userAccess.level === 'BASIC';
		    }
		    
		    return true; // Relat√≥rios p√∫blicos s√£o acess√≠veis a todos
		}
		
		// Verificar se usu√°rio pode compartilhar relat√≥rio espec√≠fico
		function canShareReport(report, userAccess) {
		    // RESEARCH pode compartilhar tudo
		    if (userAccess.level === 'FULL_ACCESS') {
		        return true;
		    }
		    
		    // ASSESSOR pode compartilhar tudo (mas com marca d'√°gua)
		    if (userAccess.level === 'PROFESSIONAL') {
		        return true;
		    }
		    
		    // INVESTIDOR s√≥ pode compartilhar relat√≥rios p√∫blicos
		    if (userAccess.level === 'BASIC') {
		        return report.access_level !== 'private';
		    }
		    
		    return false;
		}
		
		// Atualizar cards de estrat√©gia
		async function updateAllStrategies() {
		    try {
		        const reports = await getAllReports();
		        let lastUpdateDate = null;
		        let reportCount = 0;
		        let publicCount = 0;
		        let privateCount = 0;
		        
		        // Obter sess√£o do usu√°rio UMA VEZ
		        const session = getLocalSession();
		        const userAccess = session ? session.accessLevel : null;
		        const isAuthenticated = session && isLocalSessionValid(session);
		        
		        // Mapeamento de tipos
		        const strategyMap = {
		            'brasil': { 
		                updateEl: 'updateBrasil', 
		                btnEl: 'btnBrasil', 
		                lastReportEl: 'lastReportBrasil',
		                shareEl: 'shareBrasil',
		                title: 'Monalisa Brasil'
		            },
		            'global': { 
		                updateEl: 'updateGlobal', 
		                btnEl: 'btnGlobal', 
		                lastReportEl: 'lastReportGlobal',
		                shareEl: 'shareGlobal',
		                title: 'Monalisa Global'
		            },
		            'quant': { 
		                updateEl: 'updateQuant', 
		                btnEl: 'btnQuant', 
		                lastReportEl: 'lastReportQuant',
		                shareEl: 'shareQuant',
		                title: 'Monalisa Quant'
		            },
		            'opcoes': { 
		                updateEl: 'updateOpcoes', 
		                btnEl: 'btnOpcoes', 
		                lastReportEl: 'lastReportOpcoes',
		                shareEl: 'shareOpcoes',
		                title: 'Monalisa Op√ß√µes'
		            },
		            'longshort': { 
		                updateEl: 'updateLongshort', 
		                btnEl: 'btnLongshort', 
		                lastReportEl: 'lastReportLongshort',
		                shareEl: 'shareLongshort',
		                title: 'Monalisa Long/Short'
		            },
		            'vectordi': { 
		                updateEl: 'updateVectordi', 
		                btnEl: 'btnVectordi', 
		                lastReportEl: 'lastReportVectordi',
		                shareEl: 'shareVectordi',
		                title: 'Monalisa Vector DI'
		            },
		            'graficos': { 
		                updateEl: 'updateGraficos', 
		                btnEl: 'btnGraficos', 
		                lastReportEl: 'lastReportGraficos',
		                shareEl: 'shareGraficos',
		                title: 'Gr√°ficos em A√ß√£o'
		            },
		            'rendafixa': { 
		                updateEl: 'updateRendafixa', 
		                btnEl: 'btnRendafixa', 
		                lastReportEl: 'lastReportRendafixa',
		                shareEl: 'shareRendafixa',
		                title: 'De Olho na Renda Fixa'
		            },
		            'insights': { 
		                updateEl: 'updateInsights', 
		                btnEl: 'btnInsights', 
		                lastReportEl: 'lastReportInsights',
		                shareEl: 'shareInsights',
		                title: 'Monalisa Insights'
		            }
		        };
		        
		        // Resetar todos os bot√µes primeiro
		        Object.values(strategyMap).forEach(strategy => {
		            const btn = document.getElementById(strategy.btnEl);
		            if (btn) {
		                btn.disabled = true;
		                btn.innerHTML = 'Ver Relat√≥rio';
		            }
		            const shareDiv = document.getElementById(strategy.shareEl);
		            if (shareDiv) {
		                shareDiv.classList.remove('active');
		                const buttonsContainer = shareDiv.querySelector('.social-share-buttons');
		                if (buttonsContainer) {
		                    buttonsContainer.innerHTML = '';
		                }
		            }
		        });
		        
		        // Atualizar cada card com base nos dados
		        for (const [type, strategy] of Object.entries(strategyMap)) {
		            const report = reports.find(r => r.type === type);
		            const updateEl = document.getElementById(strategy.updateEl);
		            const btnEl = document.getElementById(strategy.btnEl);
		            const shareDiv = document.getElementById(strategy.shareEl);
		            
		            if (report) {
		                availableReports[type] = report;
		                const date = new Date(report.updated_at);
		                
		                updateEl.textContent = 'Dispon√≠vel';
		                
		                // Atualizar campo de √∫ltimo relat√≥rio
		                if (strategy.lastReportEl) {
		                    const lastReportEl = document.getElementById(strategy.lastReportEl);
		                    if (lastReportEl) {
		                        lastReportEl.textContent = `√öltimo relat√≥rio: ${date.toLocaleDateString('pt-BR')}`;
		                    }
		                }
		                
		                btnEl.disabled = false;
		                reportCount++;
		                
		                // Verificar se √© privado
		                const isPrivate = report.access_level === 'private';
		                
		                // L√ìGICA DE COMPARTILHAMENTO CORRIGIDA
		                let showShareButtons = false;
		                

						if (isPrivate) {
						    privateCount++;
						    
						    // Relat√≥rio privado - verificar permiss√µes
						    if (isAuthenticated && userAccess) {
						        // Usu√°rio autenticado
						        if (userAccess.level === 'FULL_ACCESS') {
						            // RESEARCH - SEM cadeado e pode compartilhar
						            btnEl.innerHTML = 'Ver Relat√≥rio'; // SEM CADEADO
						            showShareButtons = true;
						        } else if (userAccess.level === 'PROFESSIONAL') {
						            // ASSESSOR - COM cadeado e pode compartilhar
						            btnEl.innerHTML = 'üîí Ver Relat√≥rio';
						            showShareButtons = true;
						        } else if (userAccess.level === 'BASIC') {
						            // INVESTIDOR - COM cadeado e N√ÉO pode compartilhar privados
						            btnEl.innerHTML = 'üîí Ver Relat√≥rio';
						            showShareButtons = false;
						        }
						    } else {
						        // Usu√°rio N√ÉO autenticado - COM cadeado e N√ÉO mostrar compartilhamento
						        btnEl.innerHTML = 'üîí Ver Relat√≥rio';
						        showShareButtons = false;
						    }
		                } else {
		                    // Relat√≥rio P√öBLICO - todos podem compartilhar
		                    publicCount++;
		                    btnEl.innerHTML = 'Ver Relat√≥rio';
		                    showShareButtons = true; // SEMPRE mostrar para p√∫blicos
		                }
		                
		                // Aplicar visibilidade dos bot√µes de compartilhamento
						if (shareDiv) {
						    const buttonsContainer = shareDiv.querySelector('.social-share-buttons');
						    if (showShareButtons && buttonsContainer) {
						        // Criar bot√µes PRIMEIRO
						        buttonsContainer.innerHTML = createShareButtons(type, strategy.title);
						        // Depois adicionar classe active com delay m√≠nimo para garantir renderiza√ß√£o
						        setTimeout(() => {
						            shareDiv.classList.add('active');
						        }, 10);
						    } else {
						        shareDiv.classList.remove('active');
						        if (buttonsContainer) {
						            buttonsContainer.innerHTML = '';
						        }
						    }
						}
		                
		                if (!lastUpdateDate || date > lastUpdateDate) {
		                    lastUpdateDate = date;
		                }
		            } else {
		                updateEl.textContent = 'Sem dados';
		                btnEl.disabled = true;
		                
		                // Esconder compartilhamento quando n√£o h√° dados
		                if (shareDiv) {
		                    shareDiv.classList.remove('active');
		                    const buttonsContainer = shareDiv.querySelector('.social-share-buttons');
		                    if (buttonsContainer) {
		                        buttonsContainer.innerHTML = '';
		                    }
		                }
		                
		                if (strategy.lastReportEl) {
		                    const lastReportEl = document.getElementById(strategy.lastReportEl);
		                    if (lastReportEl) {
		                        lastReportEl.textContent = '√öltimo relat√≥rio: --/--/----';
		                    }
		                }
		            }
		        }
		        
		        // Processar dados de posi√ß√µes
		        await processPositionsData();
		        
		        // Atualizar √∫ltima atualiza√ß√£o global
		        if (lastUpdateDate) {
		            document.getElementById('lastUpdate').textContent = 
		                `Atualizado: ${lastUpdateDate.toLocaleDateString('pt-BR')}`;
		        }
		        
		    } catch (error) {
		        console.error('Erro ao atualizar estrat√©gias:', error);
		    }
		}
        
		// Abrir visualizador PDF
		function openPDFViewer(type) {
		    const loadingOverlay = document.getElementById('loadingOverlay');
		    loadingOverlay.style.display = 'flex';
		    
		    try {
		        // Adicionar informa√ß√µes de acesso √† sess√£o
		        const session = getLocalSession();
		        const userAccess = session ? session.accessLevel : getUserAccessLevel('INVESTIDOR');
		        const report = availableReports[type];
		        
		        // ADICIONAR: For√ßar sem marca d'√°gua para RESEARCH
		        const hasWatermark = userAccess.level === 'FULL_ACCESS' ? false : userAccess.hasWatermark;
		        
		        // Salvar informa√ß√µes de acesso para o PDF viewer
		        sessionStorage.setItem('userAccessLevel', JSON.stringify({
		            ...userAccess,
		            hasWatermark: hasWatermark  // Sobrescrever valor
		        }));
		        sessionStorage.setItem('reportAccessLevel', report ? report.access_level : 'public');
		        sessionStorage.setItem('currentReportType', type);
		        sessionStorage.setItem('userType', session?.tipo || 'INVESTIDOR'); // ADICIONAR
		        
		        const width = Math.min(1200, screen.width * 0.9);
		        const height = Math.min(800, screen.height * 0.9);
		        const left = (screen.width - width) / 2;
		        const top = (screen.height - height) / 2;
		        
		        const viewer = window.open(
		            `pdf-viewer.html?type=${type}&watermark=${hasWatermark}`, // ADICIONAR par√¢metro
		            'PDFViewer',
		            `width=${width},height=${height},left=${left},top=${top},` +
		            'toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes'
		        );
		        
		        if (!viewer) {
		            alert('Por favor, permita pop-ups para visualizar o relat√≥rio');
		        }
		        
		    } catch (error) {
		        console.error('Erro ao abrir visualizador:', error);
		        alert('Erro ao abrir relat√≥rio. Tente novamente.');
		    } finally {
		        loadingOverlay.style.display = 'none';
		    }
		}
        
        // Visualizar estrat√©gia
	function viewStrategy(type) {
    	    checkReportAccess(type);
	}
        
        // Verificar atualiza√ß√µes manualmente
        async function checkForUpdates() {
            const btn = document.querySelector('.refresh-btn');
            
            btn.disabled = true;
            btn.textContent = 'Verificando...';
            
            try {
                await updateAllStrategies();
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'Verificar Atualiza√ß√µes';
                    
                    btn.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
                    setTimeout(() => {
                        btn.style.background = '';
                    }, 1000);
                }, 1000);
            } catch (error) {
                console.error('Erro ao verificar atualiza√ß√µes:', error);
                btn.disabled = false;
                btn.textContent = 'Verificar Atualiza√ß√µes';
            }
        }
        
       // Google Sheets Service
        class GoogleSheetsService {
            constructor() {
                this.SPREADSHEET_ID = '1--E380ln9HjsiDX5fbw0NbZfXdWFn4CcTgx55Fgzw-w';
                this.SHEET_NAME = 'Assinantes';
                this.API_KEY = null;

				this.COLUMNS = {
				    NOME: 'A',
				    CPF: 'B', 
				    EMAIL: 'C',
				    TELEFONE: 'D',
				    TIPO: 'E',        // ‚Üê NOVO
				    STATUS: 'F',      // ‚Üê MOVIDO
				    DATA_INICIO: 'G', // ‚Üê MOVIDO
				    DATA_FIM: 'H'     // ‚Üê MOVIDO
				};
            }

            initialize(apiKey) {
                this.API_KEY = apiKey;
            }

            async checkSubscriberStatus(cpf) {
                try {
                    const cleanCPF = cpf.replace(/\D/g, '');
                    
                    // Corrigir o range - usar aspas simples ao inv√©s de crases
                    const range = 'Assinantes!A:H';
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${this.API_KEY}`;
                    
                    console.log('Tentando acessar URL:', url); // DEBUG
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Erro da API:', response.status, errorText);
                        
                        // Se erro 400, provavelmente a planilha n√£o est√° p√∫blica
                        if (response.status === 400) {
                            throw new Error('Planilha n√£o acess√≠vel. Verifique se est√° p√∫blica.');
                        }
                        
                        throw new Error(`Erro na API do Google Sheets: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const rows = data.values || [];
                    
                    console.log('Dados recebidos:', rows.length, 'linhas'); // DEBUG
                    
                    // Pular cabe√ßalho (linha 0)
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const rowCPF = (row[1] || '').replace(/\D/g, '');
                        
                        if (rowCPF === cleanCPF) {
							const subscriber = {
							    nome: row[0] || '',
							    cpf: rowCPF,
							    email: row[2] || '',
							    telefone: row[3] || '',
							    tipo: (row[4] || '').toUpperCase(), // ‚Üê NOVO
							    status: (row[5] || '').toLowerCase(), // ‚Üê MOVIDO
							    dataInicio: row[6] || '',            // ‚Üê MOVIDO
							    dataFim: row[7] || '',               // ‚Üê MOVIDO
							    rowIndex: i + 1
							};
                            
                            const isActive = subscriber.status === 'ativo';
                            let dateValid = true;
                            if (subscriber.dataFim) {
                                const endDate = new Date(subscriber.dataFim);
                                const today = new Date();
                                dateValid = today <= endDate;
                            }
                            
                            const finalActive = isActive && dateValid;
                            
                            return {
                                found: true,
                                active: finalActive,
                                subscriber: subscriber,
                                message: finalActive ? 
                                    'Assinante ativo' : 
                                    !isActive ? 'Assinatura inativa' : 'Assinatura expirada'
                            };
                        }
                    }
                    
                    return {
                        found: false,
                        active: false,
                        message: 'CPF n√£o encontrado na base de assinantes'
                    };
                    
                } catch (error) {
                    console.error('Erro ao buscar assinante:', error);
                    throw error;
                }
            }

            static validateCPF(cpf) {
                cpf = cpf.replace(/\D/g, '');
                if (cpf.length !== 11) return false;
                if (/^(\d)\1{10}$/.test(cpf)) return false;
                
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf.charAt(i)) * (10 - i);
                }
                let checkDigit = 11 - (sum % 11);
                if (checkDigit === 10 || checkDigit === 11) checkDigit = 0;
                if (checkDigit !== parseInt(cpf.charAt(9))) return false;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf.charAt(i)) * (11 - i);
                }
                checkDigit = 11 - (sum % 11);
                if (checkDigit === 10 || checkDigit === 11) checkDigit = 0;
                if (checkDigit !== parseInt(cpf.charAt(10))) return false;
                
                return true;
            }
        }

		// Password Service
		class PasswordService {
		    constructor() {
		        this.activeCodes = new Map();
		        this.CODE_EXPIRY = 30 * 60 * 1000; // 30 minutos
		    }

			generateTemporaryPassword(cpf) {
			    const cleanCPF = cpf.replace(/\D/g, '');
			    
			    // Sempre gerar um novo c√≥digo quando solicitado
			    const code = Math.floor(100000 + Math.random() * 900000).toString();
			    
			    this.activeCodes.set(cleanCPF, {
			        code: code,
			        timestamp: Date.now(),
			        expires: Date.now() + this.CODE_EXPIRY
			    });
			    
			    console.log('Novo c√≥digo gerado para CPF:', cleanCPF.substring(0, 3) + '***');
			    console.log('C√≥digo expira em:', new Date(Date.now() + this.CODE_EXPIRY));
			    
			    this.cleanExpiredCodes();
			    return code;
			}
		    
		    validateTemporaryPassword(cpf, code) {
		        const cleanCPF = cpf.replace(/\D/g, '');
		        const storedData = this.activeCodes.get(cleanCPF);
		        
		        if (!storedData) {
		            console.log('Nenhum c√≥digo encontrado para CPF:', cleanCPF.substring(0, 3) + '***');
		            return false;
		        }
		        
		        if (Date.now() > storedData.expires) {
		            console.log('C√≥digo expirado para CPF:', cleanCPF.substring(0, 3) + '***');
		            this.activeCodes.delete(cleanCPF);
		            return false;
		        }
		        
		        if (storedData.code === code) {
		            console.log('C√≥digo v√°lido para CPF:', cleanCPF.substring(0, 3) + '***');
		            this.activeCodes.delete(cleanCPF);
		            return true;
		        }
		        
		        console.log('C√≥digo incorreto para CPF:', cleanCPF.substring(0, 3) + '***');
		        return false;
		    }
		    
		    cleanExpiredCodes() {
		        const now = Date.now();
		        let removedCount = 0;
		        
		        for (const [cpf, data] of this.activeCodes.entries()) {
		            if (now > data.expires) {
		                this.activeCodes.delete(cpf);
		                removedCount++;
		            }
		        }
		        
		        if (removedCount > 0) {
		            console.log('C√≥digos expirados removidos:', removedCount);
		        }
		    }
		    
		    // Nova fun√ß√£o para debug
		    hasActiveCode(cpf) {
		        const cleanCPF = cpf.replace(/\D/g, '');
		        const storedData = this.activeCodes.get(cleanCPF);
		        return storedData && Date.now() < storedData.expires;
		    }
		}

        // Email Service
	// Email service ser√° carregado do arquivo email-service.js

        // Inicializar servi√ßos
        const sheetsService = new GoogleSheetsService();
        const passwordService = new PasswordService();
	let emailService = null;

		// ===== FUN√á√ïES AUXILIARES PARA SESS√ïES COMPARTILHADAS =====

		// Gerar token √∫nico para sess√£o
		function generateSessionToken() {
		    return 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
		}
		
		// Obter sess√£o local
		function getLocalSession() {
		    const session = localStorage.getItem('cpfAuthSession');
		    if (!session) return null;
		    
		    try {
		        return JSON.parse(session);
		    } catch {
		        localStorage.removeItem('cpfAuthSession');
		        return null;
		    }
		}
		
		// Verificar se sess√£o local √© v√°lida
		function isLocalSessionValid(sessionData) {
		    const now = Date.now();
		    return now < sessionData.expiresAt && (now - sessionData.timestamp) < (2 * 60 * 60 * 1000);
		}

		// Verificar sess√£o existente no servidor
		async function checkExistingSession(cpf) {
		    try {
		        const { data, error } = await supabase
		            .from('user_sessions')
		            .select('*')
		            .eq('cpf', cpf)
		            .maybeSingle(); // Use maybeSingle() ao inv√©s de single()
		        
		        if (error) {
		            console.log('Erro ao buscar sess√£o:', error.message);
		            return { hasActiveSession: false };
		        }
		        
		        if (!data) {
		            console.log('Nenhuma sess√£o encontrada no servidor');
		            return { hasActiveSession: false };
		        }
		        
		        const serverExpiresAt = new Date(data.expires_at).getTime();
		        const now = Date.now();
		        
		        if (now < serverExpiresAt) {
		            console.log('Sess√£o v√°lida encontrada no servidor');
		            return { 
		                hasActiveSession: true, 
		                sessionData: data 
		            };
		        } else {
		            console.log('Sess√£o expirada, removendo do servidor');
		            // Limpar sess√£o expirada
		            await supabase
		                .from('user_sessions')
		                .delete()
		                .eq('cpf', cpf);
		            
		            return { hasActiveSession: false };
		        }
		        
		    } catch (error) {
		        console.error('Erro ao verificar sess√£o existente:', error);
		        return { hasActiveSession: false };
		    }
		}
		
		// Restaurar sess√£o do servidor
		async function restoreServerSession(serverData, cpf) {
		    try {
		        // Buscar dados do assinante para obter o tipo/n√≠vel
		        const status = await sheetsService.checkSubscriberStatus(cpf);
		        
		        const sessionData = {
		            cpf: cpf,
		            name: serverData.subscriber_data.name,
		            email: serverData.subscriber_data.email,
		            tipo: status.subscriber?.tipo || 'INVESTIDOR', // ‚Üê ADICIONAR
		            accessLevel: getUserAccessLevel(status.subscriber?.tipo || 'INVESTIDOR'), // ‚Üê ADICIONAR
		            timestamp: new Date(serverData.created_at).getTime(),
		            expiresAt: new Date(serverData.expires_at).getTime(),
		            sessionToken: serverData.session_token
		        };
		        
		        // Salvar no localStorage
		        localStorage.setItem('cpfAuthSession', JSON.stringify(sessionData));
		        
		        // Atualizar last_accessed no servidor
		        const { error } = await supabase
		            .from('user_sessions')
		            .update({ last_accessed: new Date().toISOString() })
		            .eq('cpf', cpf);
		        
		        if (error) {
		            console.error('Erro ao atualizar last_accessed:', error);
		        }
		        
		        console.log('Sess√£o restaurada do servidor com sucesso');
		        return true;
		        
		    } catch (error) {
		        console.error('Erro ao restaurar sess√£o:', error);
		        return false;
		    }
		}
		
		// Limpar sess√£o expirada
		async function cleanExpiredSession(cpf) {
		    try {
		        await supabase
		            .from('user_sessions')
		            .delete()
		            .eq('cpf', cpf);
		        
		        localStorage.removeItem('cpfAuthSession');
		    } catch (error) {
		        console.error('Erro ao limpar sess√£o expirada:', error);
		    }
		}

		async function initializeAuthSystem() {
		    try {
		        // Inicializar Google Sheets Service
		        sheetsService.initialize(GOOGLE_SHEETS_API_KEY);
		        console.log('Google Sheets Service inicializado');
		        
		        // Aguardar carregamento do email service com timeout maior
		        let attempts = 0;
		        const maxAttempts = 20; // Aumentado de 10 para 20
		        const delayMs = 200; // Aumentado de 100ms para 200ms
		        
		        console.log('Aguardando carregamento do BrevoEmailService...');
		        
		        while (!window.BrevoEmailService && attempts < maxAttempts) {
		            await new Promise(resolve => setTimeout(resolve, delayMs));
		            attempts++;
		            
		            if (attempts % 5 === 0) {
		                console.log(`Tentativa ${attempts}/${maxAttempts} - Aguardando BrevoEmailService...`);
		            }
		        }
		        
		        // Verificar se o email service foi carregado
		        if (window.BrevoEmailService) {
		            try {
		                emailService = new window.BrevoEmailService();
		                console.log('EmailService Brevo inicializado com sucesso');
		                
		                // Testar configura√ß√£o do email service
		                const testResult = await emailService.testConfiguration();
		                
		                if (testResult.success) {
		                    console.log('Configura√ß√£o Brevo validada:', testResult.message);
		                    console.log('Endpoints:', testResult.endpoints);
		                } else {
		                    console.warn('Problema na configura√ß√£o Brevo:', testResult.message);
		                    console.warn('Endpoints:', testResult.endpoints);
		                    // N√£o quebrar a aplica√ß√£o, apenas avisar
		                }
		                
		            } catch (emailError) {
		                console.error('Erro ao inicializar ou testar EmailService:', emailError);
		                emailService = null;
		                // Continuar sem quebrar a aplica√ß√£o
		            }
		        } else {
		            console.error(`BrevoEmailService n√£o carregou ap√≥s ${maxAttempts * delayMs}ms (${maxAttempts} tentativas)`);
		            console.error('Verifique se o arquivo email-service.js est√° sendo carregado corretamente');
		            emailService = null;
		            // N√ÉO fazer throw para n√£o quebrar toda a aplica√ß√£o
		        }
		        
		        // Limpar sess√µes expiradas na inicializa√ß√£o
		        try {
		            await cleanExpiredSessions();
		            console.log('Limpeza de sess√µes expiradas conclu√≠da');
		        } catch (sessionError) {
		            console.error('Erro na limpeza de sess√µes:', sessionError);
		            // Continuar mesmo com erro na limpeza
		        }
		        
		        // Log final do status da inicializa√ß√£o
		        console.log('=== Status da Inicializa√ß√£o ===');
		        console.log('Google Sheets:', sheetsService ? 'OK' : 'ERRO');
		        console.log('Email Service:', emailService ? 'OK' : 'INDISPON√çVEL');
		        console.log('Supabase:', typeof supabase !== 'undefined' ? 'OK' : 'ERRO');
		        console.log('===============================');
		        
		        console.log('Sistema de autentica√ß√£o inicializado');
		        
		        // Retornar status para debug
		        return {
		            sheetsService: !!sheetsService,
		            emailService: !!emailService,
		            supabase: typeof supabase !== 'undefined'
		        };
		        
		    } catch (error) {
		        console.error('Erro cr√≠tico na inicializa√ß√£o do sistema:', error);
		        emailService = null;
		        
		        // Mesmo com erro, n√£o quebrar a aplica√ß√£o
		        // Apenas logar e continuar
		        throw error; // Re-throw apenas se for erro cr√≠tico
		    }
		}

		// Verificar acesso ao relat√≥rio com sistema de n√≠veis
		async function checkReportAccess(type) {
		    const report = availableReports[type];
		    
		    if (!report) {
		        alert('Relat√≥rio n√£o dispon√≠vel');
		        return;
		    }
		    
		    // Se for p√∫blico, verificar se usu√°rio pode acessar
		    if (report.access_level !== 'private') {
		        // Relat√≥rios p√∫blicos s√£o acess√≠veis a todos os n√≠veis
		        openPDFViewer(type);
		        return;
		    }
		    
		    // Para relat√≥rios privados, verificar autentica√ß√£o e n√≠vel de acesso
		    const localSession = getLocalSession();
		    
		    if (localSession && isLocalSessionValid(localSession)) {
		        // Usu√°rio tem sess√£o v√°lida, verificar n√≠vel de acesso
		        const userAccess = localSession.accessLevel || getUserAccessLevel('INVESTIDOR');
		        
		        if (canAccessReport(report, userAccess)) {
		            openPDFViewer(type);
		            return;
		        } else {
		            // Usu√°rio autenticado mas sem n√≠vel suficiente
		            let message = 'Seu n√≠vel de acesso n√£o permite visualizar este relat√≥rio.';
		            
		            switch(userAccess.level) {
		                case 'LIMITED':
		                    message = 'Este relat√≥rio √© exclusivo para assinantes. Entre em contato para upgrade.';
		                    break;
		                case 'BASIC':
		                    message = 'Este relat√≥rio √© exclusivo para assessores e pesquisadores.';
		                    break;
		                default:
		                    message = 'Acesso negado para este relat√≥rio.';
		            }
		            
		            alert(message);
		            return;
		        }
		    }
		    
		    // Se n√£o tem sess√£o local v√°lida, verificar se tem sess√£o no servidor
		    try {
		        const session = getLocalSession();
		        if (session && session.cpf) {
		            console.log('Verificando sess√£o existente no servidor...');
		            const existingSession = await checkExistingSession(session.cpf);
		            
		            if (existingSession.hasActiveSession) {
		                console.log('Sess√£o v√°lida encontrada no servidor, restaurando...');
		                const restored = await restoreServerSession(existingSession.sessionData, session.cpf);
		                
		                if (restored) {
		                    // Tentar novamente ap√≥s restaurar sess√£o
		                    setTimeout(() => checkReportAccess(type), 100);
		                    return;
		                }
		            }
		        }
		    } catch (error) {
		        console.error('Erro ao verificar sess√£o no servidor:', error);
		    }
		    
		    // Se chegou at√© aqui, precisa de autentica√ß√£o
		    pendingReportType = type;
		    showCPFAuthModal();
		}

        // Verificar sess√£o ativa
        function hasActiveSession() {
            const session = localStorage.getItem('cpfAuthSession'); // MUDAN√áA AQUI
            if (!session) return false;
            
            try {
                const data = JSON.parse(session);
                const now = Date.now();
                
                // Verificar se passou de 2 horas (2 * 60 * 60 * 1000 = 7200000 ms)
                if (now - data.timestamp > 2 * 60 * 60 * 1000) {
                    localStorage.removeItem('cpfAuthSession'); // MUDAN√áA AQUI
                    return false;
                }
                
                return true;
            } catch {
                localStorage.removeItem('cpfAuthSession'); // MUDAN√áA AQUI
                return false;
            }
        }

        // Vari√°veis de estado para autentica√ß√£o
        let currentCPF = '';
	let currentSubscriber = null;

        // Modal functions
        function showCPFAuthModal() {
            document.getElementById('cpfAuthModal').style.display = 'flex';
            document.getElementById('cpfAuthInput').focus();
            resetAuthModal();
	    setupEventListeners();
        }

        function closeCPFAuthModal() {
            document.getElementById('cpfAuthModal').style.display = 'none';
            pendingReportType = null;
            resetAuthModal();
        }

        function resetAuthModal() {
            document.querySelectorAll('.auth-step').forEach(step => step.style.display = 'none');
            document.getElementById('authStep1').style.display = 'block';
            
            document.getElementById('cpfAuthInput').value = '';
            document.getElementById('emailCodeInput').value = '';
            
            document.getElementById('cpfAuthError').style.display = 'none';
            document.getElementById('emailCodeError').style.display = 'none';
            
            currentCPF = '';
            currentSubscriber = null;
        }

        // Validar CPF e enviar c√≥digo
		async function validateCPFAndSendCode() {
		    const cpfInput = document.getElementById('cpfAuthInput').value.trim();
		    const errorDiv = document.getElementById('cpfAuthError');
		    const btn = event.target;
		    
		    errorDiv.style.display = 'none';
		    
		    if (!cpfInput) {
		        showAuthError('cpfAuthError', 'Por favor, digite seu CPF.');
		        return;
		    }
		    
		    const cleanCPF = cpfInput.replace(/\D/g, '');
		    
		    if (!GoogleSheetsService.validateCPF(cleanCPF)) {
		        showAuthError('cpfAuthError', 'CPF inv√°lido. Verifique o formato.');
		        return;
		    }
		    
		    btn.disabled = true;
		    btn.innerHTML = '<span class="loading"></span>Verificando...';
		    
		    try {
		        // PRIMEIRO: Verificar se j√° tem sess√£o ativa no servidor
		        console.log('Verificando sess√£o existente para CPF:', cleanCPF.substring(0, 3) + '***');
		        const existingSession = await checkExistingSession(cleanCPF);
		        
		        if (existingSession.hasActiveSession) {
		            console.log('Sess√£o ativa encontrada, restaurando...');
		            const restored = await restoreServerSession(existingSession.sessionData, cleanCPF);
		            
		            if (restored) {
		                showAuthStep(3);
		                setTimeout(() => {
		                    closeCPFAuthModal();
		                    if (pendingReportType) {
		                        openPDFViewer(pendingReportType);
		                    }
		                }, 2000);
		                return;
		            }
		        }
		        
		        // Verificar status do assinante
		        const status = await sheetsService.checkSubscriberStatus(cleanCPF);
		        
		        if (!status.found) {
		            showAuthError('cpfAuthError', 'CPF n√£o encontrado na base de assinantes.');
		            return;
		        }
		        
		        if (!status.active) {
		            showAuthError('cpfAuthError', status.message);
		            return;
		        }
		        
		        // Verificar se email service est√° dispon√≠vel
		        if (!emailService) {
		            console.error('EmailService n√£o dispon√≠vel');
		            showAuthError('cpfAuthError', 'Sistema de email temporariamente indispon√≠vel. Tente novamente em alguns minutos.');
		            return;
		        }
		        
		        if (!status.subscriber.email || !emailService.isValidEmail(status.subscriber.email)) {
		            showAuthError('cpfAuthError', 'Email n√£o cadastrado ou inv√°lido. Entre em contato com o suporte.');
		            return;
		        }
		
		        // Gerar c√≥digo
		        const code = passwordService.generateTemporaryPassword(cleanCPF);
		        console.log('C√≥digo gerado, enviando por email...');
		        
		        // Enviar c√≥digo por email
		        const emailResult = await emailService.sendAccessCode(
		            status.subscriber.email,
		            code,
		            status.subscriber.nome
		        );
		        
		        if (!emailResult.success) {
		            console.error('Falha no envio do email:', emailResult.error);
		            showAuthError('cpfAuthError', `Erro ao enviar email: ${emailResult.error}`);
		            return;
		        }
		        
		        console.log('Email enviado com sucesso');
		        currentCPF = cleanCPF;
		        currentSubscriber = status.subscriber;
		        
		        const maskedEmail = maskEmail(status.subscriber.email);
		        document.getElementById('maskedEmail').textContent = maskedEmail;
		        
		        showAuthStep(2);
		        
		    } catch (error) {
		        console.error('Erro na valida√ß√£o do CPF:', error);
		        showAuthError('cpfAuthError', `Erro interno: ${error.message}`);
		    } finally {
		        btn.disabled = false;
		        btn.innerHTML = 'Continuar';
		    }
		}

        // Validar c√≥digo do email
        async function validateEmailCode() {
            const codeInput = document.getElementById('emailCodeInput').value.trim();
            const errorDiv = document.getElementById('emailCodeError');
            const btn = event.target;
            
            errorDiv.style.display = 'none';
            
            if (!codeInput || codeInput.length !== 6) {
                showAuthError('emailCodeError', 'Digite o c√≥digo de 6 d√≠gitos recebido por email.');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Validando...';
            
            try {
                const isValid = passwordService.validateTemporaryPassword(currentCPF, codeInput);
                
                if (!isValid) {
                    showAuthError('emailCodeError', 'C√≥digo inv√°lido ou expirado.');
                    return;
                }
                
				await createAuthSession();
				showAuthStep(3);
				
				// Atualizar interface imediatamente
				await updateAllStrategies();
				
				setTimeout(() => {
				    closeCPFAuthModal();
				    if (pendingReportType) {
				        openPDFViewer(pendingReportType);
				    }
				}, 2000);
                
            } catch (error) {
                console.error('Erro na valida√ß√£o do c√≥digo:', error);
                showAuthError('emailCodeError', 'Erro interno. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Confirmar';
            }
        }

        // Fun√ß√µes auxiliares
		async function createAuthSession() {
		    const sessionToken = generateSessionToken();
		    const expiresAt = new Date(Date.now() + (2 * 60 * 60 * 1000));
		    
		    // GARANTIR que o tipo est√° correto
		    const userType = currentSubscriber.tipo || 'INVESTIDOR';
		    const accessLevel = getUserAccessLevel(userType);
		    
		    const sessionData = {
		        cpf: currentCPF,
		        name: currentSubscriber.nome,
		        email: currentSubscriber.email,
		        tipo: userType.toUpperCase(), // FOR√áAR UPPERCASE
		        accessLevel: {
		            ...accessLevel,
		            hasWatermark: userType === 'RESEARCH' ? false : accessLevel.hasWatermark
		        },
		        timestamp: Date.now(),
		        expiresAt: expiresAt.getTime(),
		        sessionToken: sessionToken
		    };
		    
		    try {
		        // Salvar sess√£o no Supabase para compartilhar entre dispositivos
		        const { data, error } = await supabase
		            .from('user_sessions')
		            .upsert({
		                cpf: currentCPF,
		                session_token: sessionToken,
		                subscriber_data: {
		                    name: currentSubscriber.nome,
		                    email: currentSubscriber.email,
		                    cpf: currentCPF
		                },
		                expires_at: expiresAt.toISOString(),
		                last_accessed: new Date().toISOString()
		            }, {
		                onConflict: 'cpf'
		            });
		        
		        if (error) {
		            console.error('Erro ao salvar sess√£o no Supabase:', error);
		        } else {
		            console.log('Sess√£o salva no Supabase com sucesso');
		        }
		        
		        // Tamb√©m salvar no localStorage como cache
		        localStorage.setItem('cpfAuthSession', JSON.stringify(sessionData));
		        
		        return true;
		    } catch (error) {
		        console.error('Erro ao criar sess√£o compartilhada:', error);
		        // Fallback: apenas localStorage
		        localStorage.setItem('cpfAuthSession', JSON.stringify(sessionData));
		        return false;
		    }
		}

        // 3. Fun√ß√£o para verificar e limpar sess√µes expiradas na inicializa√ß√£o
		async function cleanExpiredSessions() {
		    // Limpar sess√µes expiradas do servidor
		    try {
		        await supabase
		            .from('user_sessions')
		            .delete()
		            .lt('expires_at', new Date().toISOString());
		        
		        console.log('Sess√µes expiradas limpas do servidor');
		    } catch (error) {
		        console.error('Erro ao limpar sess√µes expiradas:', error);
		    }
		    
		    // Limpar sess√£o local se expirada
		    const localSession = localStorage.getItem('cpfAuthSession');
		    if (localSession) {
		        try {
		            const data = JSON.parse(localSession);
		            const now = Date.now();
		            
		            if (now > data.expiresAt || now - data.timestamp > 2 * 60 * 60 * 1000) {
		                localStorage.removeItem('cpfAuthSession');
		                console.log('Sess√£o local expirada removida');
		            }
		        } catch {
		            localStorage.removeItem('cpfAuthSession');
		        }
		    }
		}

        // 4. Fun√ß√£o para logout manual (opcional)
        function logoutUser() {
            localStorage.removeItem('cpfAuthSession');
            location.reload(); // Recarregar p√°gina para atualizar estado
        }

        // 5. Fun√ß√£o para verificar tempo restante da sess√£o
        function getSessionTimeRemaining() {
            const session = localStorage.getItem('cpfAuthSession');
            if (!session) return 0;
            
            try {
                const data = JSON.parse(session);
                const now = Date.now();
                const remaining = data.expiresAt - now;
                
                return Math.max(0, remaining);
            } catch {
                return 0;
            }
        }

        // 6. Fun√ß√£o para exibir tempo restante (opcional)
        function displaySessionInfo() {
            const remaining = getSessionTimeRemaining();
            if (remaining > 0) {
                const hours = Math.floor(remaining / (60 * 60 * 1000));
                const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                console.log(`Sess√£o v√°lida por mais ${hours}h ${minutes}m`);
                return `${hours}h ${minutes}m`;
            }
            return null;
        }


        // 8. OPCIONAL: Adicionar aviso quando sess√£o est√° pr√≥xima do vencimento
        function checkSessionExpiry() {
            const remaining = getSessionTimeRemaining();
            
            if (remaining > 0 && remaining < 10 * 60 * 1000) { // Menos de 10 minutos
                const minutes = Math.ceil(remaining / (60 * 1000));
                console.warn(`Sess√£o expira em ${minutes} minutos`);
                
                // Opcional: Mostrar aviso visual
                // alert(`Sua sess√£o expira em ${minutes} minutos`);
            }
        }

        function backToStep1() {
            showAuthStep(1);
            currentCPF = '';
            currentSubscriber = null;
        }

        function showAuthStep(stepNumber) {
            document.querySelectorAll('.auth-step').forEach(step => step.style.display = 'none');
            document.getElementById(`authStep${stepNumber}`).style.display = 'block';
        }

        function showAuthError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function maskEmail(email) {
            const [username, domain] = email.split('@');
            if (username.length <= 2) return email;
            
            const maskedUsername = username.substring(0, 2) + '***';
            return `${maskedUsername}@${domain}`;
        }

	// M√°scara de CPF - aguardar DOM estar pronto
        function setupEventListeners() {
            const cpfInput = document.getElementById('cpfAuthInput');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})/, '$1-$2');
                    e.target.value = value;
                });
                
                cpfInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        validateCPFAndSendCode();
                    }
                });
            }
            
            const codeInput = document.getElementById('emailCodeInput');
            if (codeInput) {
                codeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        validateEmailCode();
                    }
                });
            }
        }


        // MODIFICAR A FUN√á√ÉO viewStrategy ATUAL:
        function viewStrategy(type) {
            checkReportAccess(type);
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('cpfAuthModal');
            if (event.target === modal) {
                closeCPFAuthModal();
            }
        }

        // Inicializa√ß√£o √∫nica da p√°gina
        window.addEventListener('load', async () => {
            try {
                // Inicializar sistema de autentica√ß√£o
                await initializeAuthSystem();
                
                // Carregar e atualizar estrat√©gias
                await updateAllStrategies();
                
                console.log('Sistema inicializado completamente');
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
            }
        });

    </script>
</body>

</html>

























